/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("got"),t=require("winston"),i=require("fs"),o=require("util"),n=require("url"),r=require("tough-cookie"),s=require("node:crypto"),a=require("undici"),d=require("events");function l(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var c=l(t);function h(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const u=process.env.LOG_LEVEL||"info",{colorize:v,json:p,combine:g,timestamp:f,printf:m}=c.format,y=m((({level:e,message:t,timestamp:i})=>(["array","object"].includes(typeof t)&&(t=JSON.stringify(t,null,2)),`[${i}] ${e}: ${t}`))),b=g(f({format:"YYYY-MM-DD HH:mm:ss"}),v(),p(),y),C=c.createLogger({format:b,level:u,transports:[new c.transports.Console({})]}),w=e=>({login:`${e}/tods/api/lgn`,logout:`${e}/tods/api/lgout`,vehicleList:`${e}/tods/api/vhcllst`,vehicleInfo:`${e}/tods/api/sltvhcl`,status:`${e}/tods/api/lstvhclsts`,remoteStatus:`${e}/tods/api/rltmvhclsts`,lock:`${e}/tods/api/drlck`,unlock:`${e}/tods/api/drulck`,start:`${e}/tods/api/evc/rfon`,stop:`${e}/tods/api/evc/rfoff`,startCharge:`${e}/tods/api/evc/rcstrt`,stopCharge:`${e}/tods/api/evc/rcstp`,setChargeTarget:`${e}/tods/api/evc/setsoc`,locate:`${e}/tods/api/fndmcr`,hornlight:`${e}/tods/api/hornlight`,verifyAccountToken:`${e}/tods/api/vrfyacctkn`,verifyPin:`${e}/tods/api/vrfypin`,verifyToken:`${e}/tods/api/vrfytnc`}),k=e=>{const t=`https://${e}`;return{host:e,baseUrl:t,origin:"SPA",endpoints:Object.freeze(w(t))}},S=e=>{switch(e){case"hyundai":return Object.freeze(Object.assign({brand:"hyundai"},k("mybluelink.ca")));case"kia":return Object.freeze(Object.assign({brand:"hyundai"},k("kiaconnect.ca")));default:throw new Error(`Constructor ${e} is not managed.`)}},T=Buffer.from("IDbMgWBXgic4MAyMgf5PFFRAdGX5O3IyC3uvN3scCs0gDpTFDuyvBorlAH9JMM2/hys=","base64"),A=Buffer.from("V60WkEmyRQaAfrBF1623/7QL62MjLVbCHdItGzQ1g5T/hkmKmMVTaMHv4cKGzgD3kfc=","base64"),O=Buffer.from("wLTVxwidmH8CfJYBWSnHD6E0huk0ozdiuygB4hLkM5XCgzAL1Dk5sE36d/bx5PFMQeU=","base64"),$=Buffer.from("RFtoRq/vDXJmRndoZaZQyfOot7OrIqGVFj96iY2WL3yyH5Z/pUvlUhqmCxD2t+D65SQ=","base64");var D;!function(e){e.LOCAL="LOCAL",e.DISTANT="DISTANT"}(D||(D={}));const I=new Map,E=(t,n,r)=>()=>h(void 0,void 0,void 0,(function*(){var s;const{stamps:a,generated:d,frequency:l}=null!==(s=I.get(t))&&void 0!==s?s:yield((t,n,...r)=>h(void 0,[t,n,...r],void 0,(function*(t,n,r=`${n}${t}.v2.json`){if(r.startsWith("file://")){const[,e]=r.split("file://"),t=yield o.promisify(i.readFile)(e);return JSON.parse(t.toString("utf-8"))}const{body:s}=yield e(r,{json:!0});return I.set(t,s),s})))(t,n,r),c=new Date(d),u=Date.now()-c.getTime(),v=Math.floor(u/l);return v/(a.length-1)>=.9&&I.delete(t),a[Math.min(v,a.length-1)]})),L=(e,t,i)=>{const o=((e,t)=>{switch(t){case _.AU:return"kia"===e?T:A;case _.EU:return"kia"===e?O:$;default:throw new Error("Local stamp generation is only supported in Australia and Europe")}})(t,i);return()=>h(void 0,void 0,void 0,(function*(){const t=Buffer.from(`${e}:${Date.now()}`,"utf-8");return Promise.resolve(((e,t)=>{if(e.length!==t.length)throw new Error(`XOR Buffers are not the same size ${e.length} vs ${t.length}`);const i=Buffer.alloc(e.length);for(let o=0;o<i.length;o++)i.writeUInt8(e[o]^t[o],o);return i})(o,t).toString("base64"))}))},P=({appId:e,brand:t,mode:i,region:o,stampHost:n,stampsFile:r})=>{switch(i){case D.LOCAL:return L(e,t,o);case D.DISTANT:default:return E(`${t}-${e}`,n,r)}},R=["cs","da","nl","en","fi","fr","de","it","pl","hu","no","sk","es","sv"],M=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),V=({brand:e,stampMode:t=D.DISTANT,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.hyundai.com:8080",o=`https://${i}`,n="6d477c38-3ca4-4cf3-9557-2a1929a94654",r="1eba27d2-9a5b-4eba-8ec7-97eb6c62fb51";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(M(o,n)),basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"414998006775",stamp:P({appId:r,brand:"hyundai",mode:e,region:_.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.hyundai.com/auth/realms/euhyundaiidm/protocol/openid-connect/auth?client_id=64621b96-0f0d-11ec-82a8-0242ac130003&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.kia.com:8080",o=`https://${i}`,n="fdc85c00-0a2f-4c64-bcb4-2cfb1500730a",r="a2b8469b-30a3-4361-8e13-6fceea8fbe74";return{brand:"kia",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(M(o,n)),basicToken:"Basic ZmRjODVjMDAtMGEyZi00YzY0LWJjYjQtMmNmYjE1MDA3MzBhOnNlY3JldA==",GCMSenderID:"345127537656",stamp:P({appId:r,brand:"kia",mode:e,region:_.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.kia.com/auth/realms/eukiaidm/protocol/openid-connect/auth?client_id=572e0304-5f8d-4b4c-9dd5-41aa84eed160&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}},x=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}:443/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}:443/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),U=({brand:e})=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="prd.cn-ccapi.hyundai.com",t=`https://${e}`,i="72b3d019-5bc7-443d-a437-08f307cf06e2";return{brand:"hyundai",host:e,baseUrl:t,clientId:i,appId:"ed01581a-380f-48cd-83d4-ed1490c272d0",endpoints:Object.freeze(x(t,i)),basicToken:"Basic NzJiM2QwMTktNWJjNy00NDNkLWE0MzctMDhmMzA3Y2YwNmUyOnNlY3JldA==",GCMSenderID:"414998006775",providerDeviceId:"59af09e554a9442ab8589c9500d04d2e",pushRegId:"1"}})());case"kia":return Object.freeze((()=>{const e="prd.cn-ccapi.kia.com",t=`https://${e}`,i="9d5df92a-06ae-435f-b459-8304f2efcc67";return{brand:"kia",host:e,baseUrl:t,clientId:i,appId:"eea8762c-adfc-4ee4-8d7a-6e2452ddf342",endpoints:Object.freeze(x(t,i)),basicToken:"Basic OWQ1ZGY5MmEtMDZhZS00MzVmLWI0NTktODMwNGYyZWZjYzY3OnRzWGRrVWcwOEF2MlpaelhPZ1d6Snl4VVQ2eWVTbk5OUWtYWFBSZEtXRUFOd2wxcA==",GCMSenderID:"345127537656",providerDeviceId:"32dedba78045415b92db816e805ed47b",pushRegId:"ogc+GB5gom7zDEQjPhb3lP+bjjM=DG2rQ9Zuq0otwOU7n9y08LKjYpo="}})());default:throw new Error(`Constructor ${e} is not managed.`)}},H=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&client_id=${t}&redirect_uri=${encodeURIComponent(`${e}/api/v1/user/oauth2/redirect`)}&lang=en`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),j=({brand:e,stampMode:t=D.LOCAL,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.hyundai.com.au:8080",o=`https://${i}`,n="855c72df-dfd7-4230-ab03-67cbf902bb1c",r="f9ccfdac-a48d-4c57-bd32-9116963c24ed";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(H(o,n)),basicToken:"Basic ODU1YzcyZGYtZGZkNy00MjMwLWFiMDMtNjdjYmY5MDJiYjFjOmU2ZmJ3SE0zMllOYmhRbDBwdmlhUHAzcmY0dDNTNms5MWVjZUEzTUpMZGJkVGhDTw==",stamp:P({appId:r,brand:"hyundai",mode:e,region:_.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.kia.com.au:8082",o=`https://${i}`,n="8acb778a-b918-4a8d-8624-73a0beb64289",r="4ad4dcde-be23-48a8-bc1c-91b94f5c06f8";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(H(o,n)),basicToken:"Basic OGFjYjc3OGEtYjkxOC00YThkLTg2MjQtNzNhMGJlYjY0Mjg5OjdTY01NbTZmRVlYZGlFUEN4YVBhUW1nZVlkbFVyZndvaDRBZlhHT3pZSVMyQ3U5VA==",stamp:P({appId:r,brand:"kia",mode:e,region:_.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}};var _;!function(e){e.US="US",e.CA="CA",e.EU="EU",e.CN="CN",e.AU="AU"}(_||(_={}));const N=[50,60,70,80,90,100],F={refresh:!1,parsed:!1};class z{constructor(e,t){this.vehicleConfig=e,this.controller=t,this._fullStatus=null,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:_.EU,brand:"hyundai",autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}vin(){return this.vehicleConfig.vin}name(){return this.vehicleConfig.name}nickname(){return this.vehicleConfig.nickname}id(){return this.vehicleConfig.id}brandIndicator(){return this.vehicleConfig.brandIndicator}}class B extends z{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=_.US,C.debug(`US Vehicle ${this.vehicleConfig.regId} created`)}getDefaultHeaders(){return{access_token:this.controller.session.accessToken,client_id:this.controller.environment.clientId,Host:this.controller.environment.host,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}}fullStatus(){throw new Error("Method not implemented.")}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this._request(`/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get odometer reading!";const t=JSON.parse(e.body).enrolledVehicleDetails.find((e=>e.vehicleDetails.vin===this.vin()));return this._odometer={value:t.vehicleDetails.odometer,unit:0},this._odometer}))}location(){return h(this,void 0,void 0,(function*(){const e=yield this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get location!";const t=JSON.parse(e.body);return{latitude:t.coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}}))}start(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},{hvac:!1,duration:10,temperature:70,defrost:!1,heatedFeatures:!1,unit:"F"}),e),i={Ims:0,airCtrl:+t.hvac,airTemp:{unit:1,value:`${t.temperature}`},defrost:t.defrost,heating1:+t.heatedFeatures,igniOnDuration:t.duration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin};return 200===(yield this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"}),body:i,json:!0})).statusCode?"Vehicle started!":"Failed to start vehicle"}))}stop(){return h(this,void 0,void 0,(function*(){if(200===(yield this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"})})).statusCode)return"Vehicle stopped";throw"Failed to stop vehicle!"}))}status(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b;const C=Object.assign(Object.assign({},F),e),w=yield this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:Object.assign({REFRESH:C.refresh.toString()},this.getDefaultHeaders())}),{vehicleStatus:k}=JSON.parse(w.body),S={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==k?void 0:k.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==k?void 0:k.tirePressureLamp)||void 0===r?void 0:r.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampRearRight),all:!!(null===(l=null==k?void 0:k.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(c=null==k?void 0:k.airTemp)||void 0===c?void 0:c.value,temperatureUnit:null===(h=null==k?void 0:k.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:null==k?void 0:k.engine,accessory:null==k?void 0:k.acc,range:(null===(g=null===(p=null===(v=null===(u=null==k?void 0:k.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.totalAvailableRange)||void 0===g?void 0:g.value)||(null===(f=null==k?void 0:k.dte)||void 0===f?void 0:f.value),charging:null===(m=null==k?void 0:k.evStatus)||void 0===m?void 0:m.batteryCharge,batteryCharge12v:null===(y=null==k?void 0:k.battery)||void 0===y?void 0:y.batSoc,batteryChargeHV:null===(b=null==k?void 0:k.evStatus)||void 0===b?void 0:b.batteryStatus},lastupdate:new Date(null==k?void 0:k.dateTime)};return this._status=C.parsed?S:k,this._status}))}unlock(){return h(this,void 0,void 0,(function*(){const e=new n.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Unlock successful":"Something went wrong!"}))}lock(){return h(this,void 0,void 0,(function*(){const e=new n.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Lock successful":"Something went wrong!"}))}startCharge(){return h(this,void 0,void 0,(function*(){if(200===(yield this._request(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return C.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}))}stopCharge(){return h(this,void 0,void 0,(function*(){if(200===(yield e(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return C.debug(`Send stop charge command to vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}))}_request(t,i){return h(this,void 0,void 0,(function*(){yield this.controller.refreshAccessToken(),i.headers.access_token=this.controller.session.accessToken;const o=yield e(`${this.controller.environment.baseUrl}/${t}`,Object.assign({throwHttpErrors:!1},i));return(null==o?void 0:o.body)&&C.debug(o.body),o}))}}class J{constructor(e){this.userConfig=e,this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0}}}class Y extends Error{constructor(e,t){super(e),this.source=t,this.name=Y.ErrorName}}Y.ErrorName="ManagedBluelinkyError";const W=(t,i)=>{var o;return t instanceof e.HTTPError?new Y(`${i?`@${i}: `:""}[${t.statusCode}] ${t.statusMessage} on [${t.method}] ${t.url} - ${JSON.stringify(t.body)}`,t):t instanceof e.ParseError?new Y(`${i?`@${i}: `:""} Parsing error on [${t.method}] ${t.url} - ${JSON.stringify(null===(o=t.response)||void 0===o?void 0:o.body)}`,t):(Error,t)},G=(e,t)=>h(void 0,void 0,void 0,(function*(){const i=[];for(let o=0;o<e.length;o++)i.push(yield t(e[o],o,e));return i})),q=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));class Z extends J{constructor(e){super(e),this.vehicles=[],this._environment=(e=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="api.telematics.hyundaiusa.com";return{brand:"hyundai",host:e,baseUrl:`https://${e}`,clientId:"m66129Bb-em93-SPAHYN-bZ91-am4540zp19920",clientSecret:"v558o935-6nne-423i-baa8"}})());case"kia":return Object.freeze((()=>{const e="api.owners.kia.com";return{brand:"kia",host:e,baseUrl:`https://${e}/apigw/v1/`,clientId:"MWAMOBILE",clientSecret:"98er-w34rf-ibf3-3f6h"}})());default:throw new Error(`Constructor ${e} is not managed.`)}})(e.brand),C.debug("US Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;try{if(this.session.refreshToken&&t){C.debug("refreshing token");const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token/refresh`,{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_secret:this.environment.clientSecret,client_id:this.environment.clientId},json:!0});return C.debug(t.body),this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),C.debug("Token refreshed"),"Token refreshed"}return C.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh"}catch(e){throw W(e,"AmericanController.refreshAccessToken")}}))}login(){return h(this,void 0,void 0,(function*(){C.debug("Logging in to the API");try{const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token`,{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_id:this.environment.clientId,client_secret:this.environment.clientSecret},json:!0});return C.debug(t.body),200!==t.statusCode?"login bad":(this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),"login good")}catch(e){throw W(e,"AmericanController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){try{const t=yield e(`${this.environment.baseUrl}/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:{access_token:this.session.accessToken,client_id:this.environment.clientId,Host:this.environment.host,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}}),i=JSON.parse(t.body);return void 0===i.enrolledVehicleDetails?(this.vehicles=[],this.vehicles):(this.vehicles=i.enrolledVehicleDetails.map((e=>{const t=e.vehicleDetails,i={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};return new B(i,this)})),this.vehicles)}catch(e){throw W(e,"AmericanController.getVehicles")}}))}}var K,Q,X;!function(e){e[e.UNPLUGED=0]="UNPLUGED",e[e.FAST=1]="FAST",e[e.PORTABLE=2]="PORTABLE",e[e.STATION=3]="STATION"}(K||(K={})),function(e){e[e.FAST=0]="FAST",e[e.SLOW=1]="SLOW"}(Q||(Q={})),function(e){e[e.CLOSED=0]="CLOSED",e[e.OPEN=1]="OPEN",e[e.VENTILATION=2]="VENTILATION"}(X||(X={}));const ee=(e,t,i)=>{const o=[];for(let n=e;n<=t;n+=i)o.push(n);return o},te={EU:{start:14,end:30,step:.5},CA:{start:16,end:32,step:.5},CN:{start:14,end:30,step:.5},AU:{start:17,end:27,step:.5}},ie=(e,t)=>{const{start:i,end:o,step:n}=te[e],r=ee(i,o,n).indexOf(t);return`${("0x"+r.toString(16).substr(-4).toUpperCase()).split("x")[1].toUpperCase()}H`.padStart(3,"0")},oe=(e,t)=>{const{start:i,end:o,step:n}=te[e];return ee(i,o,n)[parseInt(t,16)]},ne=e=>{const t=parseInt(e.substring(0,4)),i=parseInt(e.substring(4,6));if(e.length<=6)return new Date(t,i-1);const o=parseInt(e.substring(6,8));if(e.length<=8)return new Date(t,i-1,o);const n=parseInt(e.substring(8,10)),r=parseInt(e.substring(10,12)),s=parseInt(e.substring(12,14));return new Date(t,i-1,o,n,r,s)},re=(e,t)=>new Date(e.getTime()+6e4*t);var se,ae;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(se||(se={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(ae||(ae={}));class de extends z{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=_.EU,this.serverRates={max:-1,current:-1},C.debug(`EU Vehicle ${this.vehicleConfig.id} created`)}start(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ie(_.EU,e.temperature),unit:e.unit}}));return C.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw W(e,"EuropeVehicle.start")}}))}stop(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return C.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw W(e,"EuropeVehicle.stop")}}))}lock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw W(e,"EuropeVehicle.lock")}}))}unlock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw W(e,"EuropeVehicle.unlock")}}))}fullStatus(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},F),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.vehicleStatusInfo,o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/ccs2/carstatus/latest`));if(null!=o.body.resMsg.state.Vehicle&&(e.ccs2Status=o.body.resMsg),t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.gpsDetail}return this._fullStatus=e,this._fullStatus}catch(e){throw W(e,"EuropeVehicle.fullStatus")}}))}status(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,S,T,A,O,$,D,I,E,L,P,R,M,V,x,U,H,j,N,z,B,J,Y;const G=Object.assign(Object.assign({},F),e),q=yield this.controller.getVehicleHttpService();try{const e=G.refresh?"":"/latest",F=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)),W=G.refresh?F.body.resMsg:F.body.resMsg.vehicleStatusInfo.vehicleStatus,Z={chassis:{hoodOpen:null==W?void 0:W.hoodOpen,trunkOpen:null==W?void 0:W.trunkOpen,locked:W.doorLock,openDoors:{frontRight:!!(null===(t=null==W?void 0:W.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==W?void 0:W.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==W?void 0:W.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==W?void 0:W.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==W?void 0:W.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==W?void 0:W.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==W?void 0:W.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==W?void 0:W.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==W?void 0:W.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==W?void 0:W.airCtrlOn,steeringwheelHeat:!!(null==W?void 0:W.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==W?void 0:W.sideBackWindowHeat),defrost:null==W?void 0:W.defrost,temperatureSetpoint:oe(_.EU,null===(c=null==W?void 0:W.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==W?void 0:W.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:W.engine,accessory:null==W?void 0:W.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==W?void 0:W.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==W?void 0:W.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==W?void 0:W.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(T=null===(S=null===(k=null==W?void 0:W.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===T?void 0:T.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==W?void 0:W.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:K.UNPLUGED,charging:null===(D=null==W?void 0:W.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==W?void 0:W.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(M=null===(R=null===(P=null==W?void 0:W.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===M?void 0:M.value,estimatedPortableChargeDuration:null===(U=null===(x=null===(V=null==W?void 0:W.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(N=null===(j=null===(H=null==W?void 0:W.evStatus)||void 0===H?void 0:H.remainTime2)||void 0===j?void 0:j.etc3)||void 0===N?void 0:N.value,batteryCharge12v:null===(z=null==W?void 0:W.battery)||void 0===z?void 0:z.batSoc,batteryChargeHV:null===(B=null==W?void 0:W.evStatus)||void 0===B?void 0:B.batteryStatus},lastupdate:(null==W?void 0:W.time)?ne(null==W?void 0:W.time):null};return Z.engine.range||(Z.engine.rangeEV||Z.engine.rangeGas)&&(Z.engine.range=(null!==(J=Z.engine.rangeEV)&&void 0!==J?J:0)+(null!==(Y=Z.engine.rangeGas)&&void 0!==Y?Y:0)),this._status=G.parsed?Z:W,this._status}catch(e){throw W(e,"EuropeVehicle.status")}}))}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,this._odometer}catch(e){throw W(e,"EuropeVehicle.odometer")}}))}location(){return h(this,void 0,void 0,(function*(){var e,t,i,o,n,r,s;const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw W(e,"EuropeVehicle.location")}}))}startCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw W(e,"EuropeVehicle.startCharge")}}))}stopCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw W(e,"EuropeVehicle.stopCharge")}}))}monthlyReport(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:le(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw W(e,"EuropeVehicle.monthyReports")}}))}tripInfo(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:le(e),setTripDay:i?ce(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?ne(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=ne(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:re(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw W(e,"EuropeVehicle.history")}}))}driveHistory(){return h(this,arguments,void 0,(function*(e=se.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?ne(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw W(e,"EuropeVehicle.history")}}))}getChargeTargets(){return h(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw W(e,"EuropeVehicle.getChargeTargets")}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!N.includes(e.fast)||!N.includes(e.slow))throw new Y(`Charge target values are limited to ${N.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:Q.FAST,targetSOClevel:e.fast},{plugType:Q.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw W(e,"EuropeVehicle.setChargeTargets")}}))}setNavigation(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw W(e,"EuropeVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function le(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function ce(e){return e.day?`${le(e)}${e.day.toString().padStart(2,"0")}`:le(e)}function he(t){return h(this,arguments,void 0,(function*(t,i="en",o){const n=null!=o?o:new r.CookieJar;return yield e(t.endpoints.session,{cookieJar:n}),yield e(t.endpoints.language,{method:"POST",body:`{"lang":"${i}"}`,cookieJar:n}),n}))}const ue={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 Mobile/15B92 Safari/604.1"},ve=e=>e.catch((e=>"HTTPError"===e.name&&302===e.statusCode?e.response:Promise.reject(e)));class pe{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanBrandAuthStrategy"}login(t,i){return h(this,void 0,void 0,(function*(){const o=yield he(this.environment,this.language,null==i?void 0:i.cookieJar),{body:{userId:r,serviceId:s}}=yield e(this.environment.endpoints.integration,{cookieJar:o,json:!0,headers:ue}),a=this.environment.brandAuthUrl({language:this.language,userId:r,serviceId:s}),d=n.parse(a,!0),{body:l}=yield e(a,{cookieJar:o,headers:ue}),c=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(l),h=null==c?void 0:c[1].replace(/&amp;/g,"&");if(!h)throw new Error("@EuropeanBrandAuthStrategy.login: cannot found the auth url from the form.");const u=new n.URLSearchParams;u.append("username",t.username),u.append("password",t.password),u.append("credentialId",""),u.append("rememberMe","on");const{headers:{location:v},body:p}=yield ve(e.post(h,{cookieJar:o,body:u.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},ue),followRedirect:!1}));if(!v){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(p);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication failed, cannot retrieve error message")}const g=yield e(v,{cookieJar:o,headers:ue});let f=g.url,m=g.body;if(!f)throw new Error(`@EuropeanBrandAuthStrategy.login: after login redirection got stuck : ${m}`);if(f.includes("login-actions/required-action")){const t=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(m),i=/name="code" value="(.*)"/gi.exec(m);if(!t)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions url.");if(!i)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions code.");const r=t[1].startsWith("/")?`${d.protocol}//${d.host}${t[1]}`:t[1],s=new n.URLSearchParams;s.append("code",i[1]),s.append("accept","");const{headers:{location:a},body:l}=yield ve(e.post(r,{cookieJar:o,body:s.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},ue)}));if(!a){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(l);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication action failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication action failed, cannot retrieve error message")}const c=yield e(a,{cookieJar:o,headers:ue});f=c.url,m=c.body}const{body:y,statusCode:b}=yield e.post(this.environment.endpoints.silentSignIn,{cookieJar:o,body:{intUserId:""},json:!0,headers:Object.assign(Object.assign({},ue),{"ccsp-service-id":this.environment.clientId})});if(!y.redirectUrl)throw new Error(`@EuropeanBrandAuthStrategy.login: silent sign In didn't work, could not retrieve auth code. status: ${b}, body: ${JSON.stringify(y)}`);const{code:C}=n.parse(y.redirectUrl,!0).query;if(!C)throw new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument code in ${y.redirectUrl}.`);return{code:C,cookies:o}}))}}class ge{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanLegacyAuthStrategy"}login(t,i){return h(this,void 0,void 0,(function*(){const o=yield he(this.environment,this.language,null==i?void 0:i.cookieJar),{body:r,statusCode:s}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!r.redirectUrl)throw new Error(`@EuropeanLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${s}, body: ${JSON.stringify(r)}`);const{code:a}=n.parse(r.redirectUrl,!0).query;if(!a)throw new Error("@EuropeanLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:a,cookies:o}}))}}class fe extends J{constructor(e){var t;if(super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:q(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.userConfig.language=null!==(t=e.language)&&void 0!==t?t:"en",!R.includes(this.userConfig.language))throw new Error(`The language code ${this.userConfig.language} is not managed. Only ${R.join(", ")} are.`);this.session.deviceId=q(),this._environment=V(e),this.authStrategies={main:new pe(this._environment,this.userConfig.language),fallback:new ge(this._environment,this.userConfig.language)},C.debug("EU Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return C.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return C.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new n.URLSearchParams;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return C.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw W(e,"EuropeController.refreshAccessToken")}return C.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return h(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw W(e,"EuropeController.pin")}}))}login(){return h(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@EuropeController.login: username and password must be defined.");let t=null;try{C.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){C.error(`@EuropeController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),C.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.fallback.name}`),t=yield this.authStrategies.fallback.login({password:this.userConfig.password,username:this.userConfig.username})}C.debug("@EuropeController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"APNS",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),C.debug("@EuropeController.login: Device registered");const r=new n.URLSearchParams;r.append("grant_type","authorization_code"),r.append("redirect_uri",this.environment.endpoints.redirectUri),r.append("code",t.code);const s=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:r.toString(),cookieJar:t.cookies});if(200!==s.statusCode)throw new Error(`@EuropeController.login: Could not manage to get token: ${s.body}`);if(s){const e=JSON.parse(s.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return C.debug("@EuropeController.login: Session defined properly"),"Login success"}catch(e){throw W(e,"EuropeController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield G(t.body.resMsg.vehicles,(t=>h(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return C.debug(`@EuropeController.getVehicles: Added vehicle ${o.id}`),new de(o,this)}))))}catch(e){throw W(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){return h(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return h(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return h(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}class me extends z{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=_.CA,this.timeOffset=-(new Date).getTimezoneOffset()/60,this._info=null,C.debug(`CA Vehicle ${this.vehicleConfig.id} created`)}fullStatus(){throw new Error("Method not implemented.")}status(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m;const y=Object.assign(Object.assign({},F),e);C.debug("Begin status request, polling car",y.refresh);try{let e=null;if(y.useInfo)yield this.setInfo(y.refresh),this._info&&(e=this._info.status);else{const o=y.refresh?this.controller.environment.endpoints.remoteStatus:this.controller.environment.endpoints.status,n=yield this.request(o,{});if(e=null===(t=n.result)||void 0===t?void 0:t.status,null==n?void 0:n.error)throw null===(i=null==n?void 0:n.error)||void 0===i?void 0:i.errorDesc}C.debug(e);let b=null;return e&&(b={chassis:{hoodOpen:null==e?void 0:e.hoodOpen,trunkOpen:null==e?void 0:e.trunkOpen,locked:null==e?void 0:e.doorLock,openDoors:{frontRight:!!(null===(o=null==e?void 0:e.doorOpen)||void 0===o?void 0:o.frontRight),frontLeft:!!(null===(n=null==e?void 0:e.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==e?void 0:e.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(s=null==e?void 0:e.doorOpen)||void 0===s?void 0:s.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(a=null==e?void 0:e.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampRearLeft),frontLeft:!!(null===(d=null==e?void 0:e.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampFrontLeft),frontRight:!!(null===(l=null==e?void 0:e.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==e?void 0:e.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(h=null==e?void 0:e.tirePressureLamp)||void 0===h?void 0:h.tirePressureWarningLampAll)}},climate:{active:null==e?void 0:e.airCtrlOn,steeringwheelHeat:!!(null==e?void 0:e.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==e?void 0:e.sideBackWindowHeat),defrost:null==e?void 0:e.defrost,temperatureSetpoint:null===(u=null==e?void 0:e.airTemp)||void 0===u?void 0:u.value,temperatureUnit:null===(v=null==e?void 0:e.airTemp)||void 0===v?void 0:v.unit},engine:{ignition:null==e?void 0:e.engine,accessory:null==e?void 0:e.acc,range:null===(p=null==e?void 0:e.dte)||void 0===p?void 0:p.value,charging:null===(g=null==e?void 0:e.evStatus)||void 0===g?void 0:g.batteryCharge,batteryCharge12v:null===(f=null==e?void 0:e.battery)||void 0===f?void 0:f.batSoc,batteryChargeHV:null===(m=null==e?void 0:e.evStatus)||void 0===m?void 0:m.batteryStatus},lastupdate:ne(null==e?void 0:e.lastStatusDate)}),this._status=y.parsed?b:e,this._status}catch(e){throw e.message}}))}lock(){return h(this,void 0,void 0,(function*(){C.debug("Begin lock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.lock,{},{pAuth:e}),"Lock successful"}catch(e){throw e.message}}))}unlock(){return h(this,void 0,void 0,(function*(){C.debug("Begin unlock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.unlock,{},{pAuth:e}),"Unlock successful"}catch(e){throw e.message}}))}start(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r;C.debug("Begin startClimate request");try{const s={hvacInfo:{airCtrl:null!==(t=e.hvac)&&void 0!==t&&t||null!==(i=e.defrost)&&void 0!==i&&i?1:0,defrost:null!==(o=e.defrost)&&void 0!==o&&o,heating1:e.heatedFeatures?1:0}},a=e.temperature;if(null!=a)s.hvacInfo.airTemp={value:ie(_.CA,a),unit:0,hvacTempType:1};else if(null!==(n=e.hvac)&&void 0!==n&&n||null!==(r=e.defrost)&&void 0!==r&&r)throw"air temperature should be specified";const d=yield this.getPreAuth(),l=yield this.request(this.controller.environment.endpoints.start,s,{pAuth:d});return C.debug(l),l.responseHeader&&0===l.responseHeader.responseCode?"Vehicle started!":"Failed to start vehicle"}catch(e){throw e.message}}))}stop(){return h(this,void 0,void 0,(function*(){C.debug("Begin stop request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.stop,{pAuth:e})}catch(e){throw"error: "+e}}))}lights(){return h(this,arguments,void 0,(function*(e=!1){C.debug("Begin lights request with horn "+e);try{const t=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.hornlight,{horn:e},{pAuth:t})}catch(e){throw"error: "+e}}))}stopCharge(){return h(this,void 0,void 0,(function*(){C.debug("Begin stopCharge");const{stopCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}startCharge(){return h(this,void 0,void 0,(function*(){C.debug("Begin startCharge");const{startCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){if(C.debug("Begin setChargeTarget"),!N.includes(e.fast)||!N.includes(e.slow))throw new Y(`Charge target values are limited to ${N.join(", ")}`);const{setChargeTarget:t}=this.controller.environment.endpoints;try{const i=yield this.getPreAuth();return yield this.request(t,{pin:this.controller.userConfig.pin,pAuth:i,tsoc:[{plugType:Q.FAST,level:e.fast},{plugType:Q.SLOW,level:e.slow}]})}catch(e){throw"error: "+e}}))}odometer(){return h(this,void 0,void 0,(function*(){try{if(yield this.setInfo(),this._info)return{unit:this._info.vehicle.odometer,value:this._info.vehicle.odometerUnit};throw"error: no info"}catch(e){throw"error: "+e}}))}location(){return h(this,void 0,void 0,(function*(){C.debug("Begin locate request");try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.locate,{},{pAuth:e});return this._location=t.result,this._location}catch(e){throw"error: "+e}}))}getPreAuth(){return h(this,void 0,void 0,(function*(){C.info("Begin pre-authentication");try{return(yield this.request(this.controller.environment.endpoints.verifyPin,{})).result.pAuth}catch(e){throw"error: "+e}}))}request(t,i){return h(this,arguments,void 0,(function*(t,i,o={}){C.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`),yield this.controller.refreshAccessToken();const[n,,]=process.versions.node.split(".").map(Number);if(n>=21){i=Object.assign({pin:this.userConfig.pin},i),process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",C.debug("Node version >= 21, using fetch instead of got");const e={method:"POST",body:JSON.stringify(i),headers:Object.assign({from:this.controller.environment.origin,language:0,offset:this.timeOffset,accessToken:this.controller.session.accessToken,Origin:"https://kiaconnect.ca",Referer:"https://kiaconnect.ca/login","Content-Type":"application/json",vehicleId:this.vehicleConfig.id},o),dispatcher:new a.Agent({connect:{rejectUnauthorized:!1,secureOptions:s.constants.SSL_OP_LEGACY_SERVER_CONNECT}})};try{const i=yield a.fetch(t,e);return yield i.json()}catch(e){return void C.error(e)}}const r={method:"POST",json:!0,throwHttpErrors:!1,headers:Object.assign({from:this.controller.environment.origin,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},o),body:Object.assign({pin:this.userConfig.pin},i)};try{const i=yield e(t,r);return 0!=i.body.responseHeader.responseCode?i.body.responseHeader.responseDesc:i.body}catch(e){throw"error: "+e}}))}setInfo(){return h(this,arguments,void 0,(function*(e=!1){if(null===this._info||e)try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.vehicleInfo,{},{pAuth:e});this._info=t.result}catch(e){throw"error: "+e}}))}}class ye extends J{constructor(e){super(e),this.vehicles=[],this.timeOffset=-(new Date).getTimezoneOffset()/60,C.debug("CA Controller created"),this._environment=S(e.brand)}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;return C.debug("shouldRefreshToken: "+e.toString()),this.session.refreshToken&&e?(yield this.login(),C.debug("Token refreshed"),"Token refreshed"):(C.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh")}))}login(){return h(this,void 0,void 0,(function*(){C.info("Begin login request");try{const e=yield this.request(this.environment.endpoints.login,{loginId:this.userConfig.username,password:this.userConfig.password});return C.debug(e.result),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),"login good"}catch(e){return"error: "+e}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){C.info("Begin getVehicleList request");try{const e=(yield this.request(this.environment.endpoints.vehicleList,{})).result;return void 0===e.vehicles?(this.vehicles=[],this.vehicles):(e.vehicles.forEach((e=>{const t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};this.vehicles.push(new me(t,this))})),this.vehicles)}catch(e){return C.debug(e),this.vehicles}}))}request(t,i){return h(this,arguments,void 0,(function*(t,i,o={}){C.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`);const[n,,]=process.versions.node.split(".").map(Number);if(n>=21){process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",C.debug("Node version >= 21, using fetch instead of got");const e={method:"POST",body:JSON.stringify(i),headers:Object.assign({from:this.environment.origin,language:0,offset:this.timeOffset,accessToken:this.session.accessToken,Origin:"https://kiaconnect.ca",Referer:"https://kiaconnect.ca/login","Content-Type":"application/json"},o),dispatcher:new a.Agent({connect:{rejectUnauthorized:!1,secureOptions:s.constants.SSL_OP_LEGACY_SERVER_CONNECT}})};try{const i=yield a.fetch(t,e);return yield i.json()}catch(e){return void C.error(e)}}try{const n=yield e(t,{method:"POST",json:!0,headers:Object.assign({from:this.environment.origin,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},o),body:Object.assign({},i)});if(0!=n.body.responseHeader.responseCode)throw n.body.responseHeader.responseDesc;return n.body}catch(e){throw W(e,"CanadianController")}}))}}var be,Ce;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(be||(be={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(Ce||(Ce={}));class we extends z{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=_.CN,this.serverRates={max:-1,current:-1},C.debug(`CN Vehicle ${this.vehicleConfig.id} created`)}start(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:1,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ie(_.CN,e.temperature),unit:e.unit}}));return C.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw W(e,"ChinaVehicle.start")}}))}stop(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return C.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw W(e,"ChinaVehicle.stop")}}))}lock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw W(e,"ChinaVehicle.lock")}}))}unlock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw W(e,"ChinaVehicle.unlock")}}))}fullStatus(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},F),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.status;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg.status;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.coord}return this._fullStatus=e,this._fullStatus}catch(e){throw W(e,"ChinaVehicle.fullStatus")}}))}status(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,S,T,A,O,$,D,I,E,L,P,R,M,V,x,U,H,j,N,z,B,J,Y;const G=Object.assign(Object.assign({},F),e),q=yield this.controller.getVehicleHttpService();try{const e=G.refresh?"":"/latest",F=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg.status,W={chassis:{hoodOpen:null==F?void 0:F.hoodOpen,trunkOpen:null==F?void 0:F.trunkOpen,locked:F.doorLock,openDoors:{frontRight:!!(null===(t=null==F?void 0:F.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==F?void 0:F.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==F?void 0:F.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==F?void 0:F.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==F?void 0:F.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==F?void 0:F.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==F?void 0:F.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==F?void 0:F.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==F?void 0:F.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==F?void 0:F.airCtrlOn,steeringwheelHeat:!!(null==F?void 0:F.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==F?void 0:F.sideBackWindowHeat),defrost:null==F?void 0:F.defrost,temperatureSetpoint:oe(_.EU,null===(c=null==F?void 0:F.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==F?void 0:F.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:F.engine,accessory:null==F?void 0:F.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==F?void 0:F.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==F?void 0:F.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==F?void 0:F.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(T=null===(S=null===(k=null==F?void 0:F.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===T?void 0:T.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==F?void 0:F.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:K.UNPLUGED,charging:null===(D=null==F?void 0:F.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==F?void 0:F.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(M=null===(R=null===(P=null==F?void 0:F.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===M?void 0:M.value,estimatedPortableChargeDuration:null===(U=null===(x=null===(V=null==F?void 0:F.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(N=null===(j=null===(H=null==F?void 0:F.evStatus)||void 0===H?void 0:H.remainTime2)||void 0===j?void 0:j.etc3)||void 0===N?void 0:N.value,batteryCharge12v:null===(z=null==F?void 0:F.battery)||void 0===z?void 0:z.batSoc,batteryChargeHV:null===(B=null==F?void 0:F.evStatus)||void 0===B?void 0:B.batteryStatus},lastupdate:(null==F?void 0:F.time)?ne(null==F?void 0:F.time):null};return W.engine.range||(W.engine.rangeEV||W.engine.rangeGas)&&(W.engine.range=(null!==(J=W.engine.rangeEV)&&void 0!==J?J:0)+(null!==(Y=W.engine.rangeGas)&&void 0!==Y?Y:0)),this._status=G.parsed?W:F,this._status}catch(e){throw W(e,"ChinaVehicle.status")}}))}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.status.odometer,this._odometer}catch(e){throw W(e,"ChinaVehicle.odometer")}}))}location(){return h(this,void 0,void 0,(function*(){var e,t,i,o,n,r,s;const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw W(e,"ChinaVehicle.location")}}))}startCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw W(e,"ChinaVehicle.startCharge")}}))}stopCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw W(e,"ChinaVehicle.stopCharge")}}))}monthlyReport(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:ke(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw W(e,"ChinaVehicle.monthyReports")}}))}tripInfo(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:ke(e),setTripDay:i?Se(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?ne(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=ne(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:re(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw W(e,"ChinaVehicle.history")}}))}driveHistory(){return h(this,arguments,void 0,(function*(e=be.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?ne(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw W(e,"ChinaVehicle.history")}}))}getChargeTargets(){return h(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw W(e,"ChinaVehicle.getChargeTargets")}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!N.includes(e.fast)||!N.includes(e.slow))throw new Y(`Charge target values are limited to ${N.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:Q.FAST,targetSOClevel:e.fast},{plugType:Q.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw W(e,"ChinaVehicle.setChargeTargets")}}))}setNavigation(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw W(e,"ChinaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function ke(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function Se(e){return e.day?`${ke(e)}${e.day.toString().padStart(2,"0")}`:ke(e)}class Te{constructor(e){this.environment=e}get name(){return"ChineseLegacyAuthStrategy"}login(t,i){return h(this,void 0,void 0,(function*(){const o=yield function(t,i){return h(this,void 0,void 0,(function*(){const o=null!=i?i:new r.CookieJar;return yield e(t.endpoints.session,{cookieJar:o}),yield e(t.endpoints.language,{method:"POST",body:'{"lang":"zh"}',cookieJar:o}),o}))}(this.environment,null==i?void 0:i.cookieJar),{body:s,statusCode:a}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!s.redirectUrl)throw new Error(`@ChineseLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${a}, body: ${JSON.stringify(s)}`);const{code:d}=n.parse(s.redirectUrl,!0).query;if(!d)throw new Error("@ChineseLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:d,cookies:o}}))}}class Ae extends J{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:q(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=q(),this._environment=U(e),this.authStrategies={main:new Te(this._environment)},C.debug("CN Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return C.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return C.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new n.URLSearchParams;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return C.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw W(e,"ChinaController.refreshAccessToken")}return C.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return h(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin?token=`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,C.debug(`controlToken is : ${this.session.controlToken}`),this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw W(e,"ChinaController.pin")}}))}login(){return h(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@ChinaController.login: username and password must be defined.");let t=null;try{C.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){C.error(`@ChinaController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),C.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}C.debug("@ChinaController.login: Authenticated properly with user and password");const i=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId},body:{pushRegId:this.environment.pushRegId,providerDeviceId:this.environment.providerDeviceId,pushType:"GCM",uuid:q()},json:!0});i&&(this.session.deviceId=i.body.resMsg.deviceId),C.debug("@ChinaController.login: Device registered");const o=new n.URLSearchParams;o.append("grant_type","authorization_code"),o.append("redirect_uri",this.environment.endpoints.redirectUri),o.append("code",t.code);const r=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:o.toString(),cookieJar:t.cookies});if(200!==r.statusCode)throw new Error(`@ChinaController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return C.debug("@ChinaController.login: Session defined properly"),C.debug(`accessToken is ${this.session.accessToken}\n refreshToken is ${this.session.refreshToken}\n tokenExpiresAt : ${this.session.tokenExpiresAt}`),"Login success"}catch(e){throw W(e,"ChinaController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0});this.vehicles=yield G(t.body.resMsg.vehicles,(t=>h(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return C.debug(`@ChineseController.getVehicles: Added vehicle ${o.id}`),new we(o,this)}))))}catch(e){throw W(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){return h(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return h(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,AuthorizationCCSP:this.session.controlToken,"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c"}),json:!0})}))}getApiHttpService(){return h(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign({},this.defaultHeaders),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(0),"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c","ccsp-application-id":this.environment.appId,"Content-Type":"application/json","User-Agent":"okhttp/4.4.0"}}}class Oe extends z{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=_.AU,this.serverRates={max:-1,current:-1},C.debug(`AU Vehicle ${this.vehicleConfig.id} created`)}start(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ie(_.AU,e.temperature),unit:e.unit}}));return C.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw W(e,"AustraliaVehicle.start")}}))}stop(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return C.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw W(e,"AustraliaVehicle.stop")}}))}lock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw W(e,"AustraliaVehicle.lock")}}))}unlock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(C.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw W(e,"AustraliaVehicle.unlock")}}))}setWindows(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/windowcurtain`,{body:e}));return C.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw W(e,"AustraliaVehicle.start")}}))}fullStatus(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},F),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(t.refresh?yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`):yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`)),o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)),n=yield this.odometer();return n?(this._fullStatus={vehicleLocation:o.body.resMsg.gpsDetail,odometer:n,vehicleStatus:e.body.resMsg},this._fullStatus):null}catch(e){throw W(e,"AustraliaVehicle.fullStatus")}}))}status(e){return h(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,S,T,A,O,$,D,I,E,L,P,R,M,V,x,U,H,j,N,z,B,J,Y;const G=Object.assign(Object.assign({},F),e),q=yield this.controller.getVehicleHttpService();try{const e=G.refresh?"":"/latest",F=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg,W={chassis:{hoodOpen:null==F?void 0:F.hoodOpen,trunkOpen:null==F?void 0:F.trunkOpen,locked:F.doorLock,openDoors:{frontRight:!!(null===(t=null==F?void 0:F.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==F?void 0:F.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==F?void 0:F.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==F?void 0:F.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==F?void 0:F.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==F?void 0:F.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==F?void 0:F.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==F?void 0:F.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==F?void 0:F.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==F?void 0:F.airCtrlOn,steeringwheelHeat:!!(null==F?void 0:F.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==F?void 0:F.sideBackWindowHeat),defrost:null==F?void 0:F.defrost,temperatureSetpoint:oe(_.AU,null===(c=null==F?void 0:F.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==F?void 0:F.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:F.engine,accessory:null==F?void 0:F.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==F?void 0:F.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==F?void 0:F.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==F?void 0:F.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(T=null===(S=null===(k=null==F?void 0:F.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===T?void 0:T.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==F?void 0:F.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:K.UNPLUGED,charging:null===(D=null==F?void 0:F.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==F?void 0:F.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(M=null===(R=null===(P=null==F?void 0:F.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===M?void 0:M.value,estimatedPortableChargeDuration:null===(U=null===(x=null===(V=null==F?void 0:F.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(N=null===(j=null===(H=null==F?void 0:F.evStatus)||void 0===H?void 0:H.remainTime2)||void 0===j?void 0:j.etc3)||void 0===N?void 0:N.value,batteryCharge12v:null===(z=null==F?void 0:F.battery)||void 0===z?void 0:z.batSoc,batteryChargeHV:null===(B=null==F?void 0:F.evStatus)||void 0===B?void 0:B.batteryStatus},lastupdate:(null==F?void 0:F.time)?ne(null==F?void 0:F.time):null};return W.engine.range||(W.engine.rangeEV||W.engine.rangeGas)&&(W.engine.range=(null!==(J=W.engine.rangeEV)&&void 0!==J?J:0)+(null!==(Y=W.engine.rangeGas)&&void 0!==Y?Y:0)),this._status=G.parsed?W:F,this._status}catch(e){throw W(e,"AustraliaVehicle.status")}}))}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:$e({year:(new Date).getFullYear(),month:(new Date).getMonth()+1})}}));return this._odometer={unit:0,value:t.body.resMsg.odometer},this._odometer}catch(e){throw W(e,"AustraliaVehicle.odometer")}}))}location(){return h(this,void 0,void 0,(function*(){var e,t,i,o,n,r;const s=yield this.controller.getVehicleHttpService();try{const a=null===(e=this.updateRates(yield s.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)).body.resMsg)||void 0===e?void 0:e.gpsDetail;return this._location={latitude:null===(t=null==a?void 0:a.coord)||void 0===t?void 0:t.lat,longitude:null===(i=null==a?void 0:a.coord)||void 0===i?void 0:i.lon,altitude:null===(o=null==a?void 0:a.coord)||void 0===o?void 0:o.alt,speed:{unit:null===(n=null==a?void 0:a.speed)||void 0===n?void 0:n.unit,value:null===(r=null==a?void 0:a.speed)||void 0===r?void 0:r.value},heading:null==a?void 0:a.head},this._location}catch(e){throw W(e,"AustraliaVehicle.location")}}))}startCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw W(e,"AustraliaVehicle.startCharge")}}))}stopCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return C.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw W(e,"AustraliaVehicle.stopCharge")}}))}monthlyReport(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:$e(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw W(e,"AustraliaVehicle.monthyReports")}}))}tripInfo(){return h(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:$e(e),setTripDay:i?De(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?ne(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=ne(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:re(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw W(e,"AustraliaVehicle.history")}}))}driveHistory(){return h(this,arguments,void 0,(function*(e=se.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?ne(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw W(e,"AustraliaVehicle.history")}}))}getChargeTargets(){return h(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw W(e,"AustraliaVehicle.getChargeTargets")}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!N.includes(e.fast)||!N.includes(e.slow))throw new Y(`Charge target values are limited to ${N.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:Q.FAST,targetSOClevel:e.fast},{plugType:Q.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw W(e,"AustraliaVehicle.setChargeTargets")}}))}setNavigation(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw W(e,"AustraliaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function $e(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function De(e){return e.day?`${$e(e)}${e.day.toString().padStart(2,"0")}`:$e(e)}class Ie{constructor(e){this.environment=e}get name(){return"AustraliaAuthStrategy"}login(t,i){return h(this,void 0,void 0,(function*(){var o;const s=null!==(o=null==i?void 0:i.cookieJar)&&void 0!==o?o:new r.CookieJar;yield e(this.environment.endpoints.session,{cookieJar:s});const{body:a,statusCode:d}=yield e(this.environment.endpoints.login,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({email:t.username,password:t.password,mobileNum:""}),cookieJar:s}),l=JSON.parse(a);if(!l.redirectUrl)throw new Error(`@AustraliaAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${d}, body: ${JSON.stringify(l)}`);const{code:c}=n.parse(l.redirectUrl,!0).query;if(!c)throw new Error("@AustraliaAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:c,cookies:s}}))}}class Ee extends J{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:q(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=q(),this._environment=j(e),this.authStrategy=new Ie(this._environment),C.debug("AU Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return C.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return C.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new n.URLSearchParams;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return C.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw W(e,"AustraliaController.refreshAccessToken")}return C.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return h(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw W(e,"AustraliaController.pin")}}))}login(){return h(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@AustraliaController.login: username and password must be defined.");let t=null;try{C.debug(`@AustraliaController.login: Trying to sign in with ${this.authStrategy.name}`),t=yield this.authStrategy.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){throw new Error(`@AustraliaController.login: sign in with ${this.authStrategy.name} failed with error ${e.toString()}`)}C.debug("@AustraliaController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"GCM",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),C.debug("@AustraliaController.login: Device registered");const r=new n.URLSearchParams;r.append("grant_type","authorization_code"),r.append("redirect_uri",this.environment.endpoints.redirectUri),r.append("code",t.code);const s=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:r.toString(),cookieJar:t.cookies});if(200!==s.statusCode)throw new Error(`@AustraliaController.login: Could not manage to get token: ${s.body}`);if(s){const e=JSON.parse(s.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return C.debug("@AustraliaController.login: Session defined properly"),"Login success"}catch(e){throw W(e,"AustraliaController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield G(t.body.resMsg.vehicles,(t=>h(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return C.debug(`@AustraliaController.getVehicles: Added vehicle ${o.id}`),new Oe(o,this)}))))}catch(e){throw W(e,"AustraliaController.getVehicles")}return this.vehicles}))}checkControlToken(){return h(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return h(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return h(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}const Le={username:"",password:"",region:_.US,brand:"hyundai",autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0};class Pe extends d.EventEmitter{constructor(e){switch(super(),this.vehicles=[],this.config=Object.assign(Object.assign({},Le),e),e.region){case _.EU:this.controller=new fe(this.config);break;case _.US:this.controller=new Z(this.config);break;case _.CA:this.controller=new ye(this.config);break;case _.CN:this.controller=new Ae(this.config);break;case _.AU:this.controller=new Ee(this.config);break;default:throw new Error("Your region is not supported yet.")}void 0===e.autoLogin&&(this.config.autoLogin=!0),this.onInit()}on(e,t){return super.on(e,t)}onInit(){this.config.autoLogin&&(C.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())}login(){return h(this,void 0,void 0,(function*(){try{const e=yield this.controller.login();return this.vehicles=yield this.getVehicles(),C.debug(`Found ${this.vehicles.length} on the account`),this.emit("ready",this.vehicles),e}catch(e){return this.emit("error",e),e.message}}))}getVehicles(){return h(this,void 0,void 0,(function*(){return(yield this.controller.getVehicles())||[]}))}getVehicle(e){try{const t=this.vehicles.find((t=>t.vin().toLowerCase()===e.toLowerCase()));if(!t&&this.vehicles.length>0)throw new Error(`Could not find vehicle with id: ${e}`);return t}catch(t){throw new Error(`Vehicle not found: ${e}!`)}}refreshAccessToken(){return h(this,void 0,void 0,(function*(){return this.controller.refreshAccessToken()}))}logout(){return h(this,void 0,void 0,(function*(){return this.controller.logout()}))}getSession(){return this.controller.session}get cachedVehicles(){var e;return null!==(e=this.vehicles)&&void 0!==e?e:[]}}exports.BlueLinky=Pe,exports.default=Pe;
