/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
"use strict";var e=require("got"),t=require("winston"),i=require("fs"),o=require("util"),n=require("url"),r=require("tough-cookie"),s=require("events");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function d(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var l=a(e),c=d(t),u=a(n);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function h(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))}const v=process.env.LOG_LEVEL||"info",{colorize:p,json:g,combine:f,timestamp:m,printf:y}=c.format,b=y((({level:e,message:t,timestamp:i})=>(["array","object"].includes(typeof t)&&(t=JSON.stringify(t,null,2)),`[${i}] ${e}: ${t}`))),C=f(m({format:"YYYY-MM-DD HH:mm:ss"}),p(),g(),b),w=c.createLogger({format:C,level:v,transports:[new c.transports.Console({})]}),k=e=>({login:`${e}/tods/api/lgn`,logout:`${e}/tods/api/lgout`,vehicleList:`${e}/tods/api/vhcllst`,vehicleInfo:`${e}/tods/api/sltvhcl`,status:`${e}/tods/api/lstvhclsts`,remoteStatus:`${e}/tods/api/rltmvhclsts`,lock:`${e}/tods/api/drlck`,unlock:`${e}/tods/api/drulck`,start:`${e}/tods/api/evc/rfon`,stop:`${e}/tods/api/evc/rfoff`,startCharge:`${e}/tods/api/evc/rcstrt`,stopCharge:`${e}/tods/api/evc/rcstp`,setChargeTarget:`${e}/tods/api/evc/setsoc`,locate:`${e}/tods/api/fndmcr`,hornlight:`${e}/tods/api/hornlight`,verifyAccountToken:`${e}/tods/api/vrfyacctkn`,verifyPin:`${e}/tods/api/vrfypin`,verifyToken:`${e}/tods/api/vrfytnc`}),S=e=>{const t=`https://${e}`;return{host:e,baseUrl:t,origin:"SPA",endpoints:Object.freeze(k(t))}},T=e=>{switch(e){case"hyundai":return Object.freeze(Object.assign({brand:"hyundai"},S("mybluelink.ca")));case"kia":return Object.freeze(Object.assign({brand:"hyundai"},S("kiaconnect.ca")));default:throw new Error(`Constructor ${e} is not managed.`)}};var A,O;!function(e){e[e.UNPLUGED=0]="UNPLUGED",e[e.FAST=1]="FAST",e[e.PORTABLE=2]="PORTABLE",e[e.STATION=3]="STATION"}(A||(A={})),function(e){e[e.FAST=0]="FAST",e[e.SLOW=1]="SLOW"}(O||(O={}));class ${constructor(e,t){this.vehicleConfig=e,this.controller=t,this._fullStatus=null,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:le.EU,brand:"hyundai",autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}vin(){return this.vehicleConfig.vin}name(){return this.vehicleConfig.name}nickname(){return this.vehicleConfig.nickname}id(){return this.vehicleConfig.id}brandIndicator(){return this.vehicleConfig.brandIndicator}}const D=(e,t,i)=>{const o=[];for(let n=e;n<=t;n+=i)o.push(n);return o},I={EU:{start:14,end:30,step:.5},CA:{start:16,end:32,step:.5},CN:{start:14,end:30,step:.5}},L=(e,t)=>{const{start:i,end:o,step:n}=I[e],r=D(i,o,n).indexOf(t);return`${("0x"+r.toString(16).substr(-4).toUpperCase()).split("x")[1].toUpperCase()}H`.padStart(3,"0")},E=(e,t)=>{const{start:i,end:o,step:n}=I[e];return D(i,o,n)[parseInt(t,16)]},P=e=>{const t=parseInt(e.substring(0,4)),i=parseInt(e.substring(4,6));if(e.length<=6)return new Date(t,i-1);const o=parseInt(e.substring(6,8));if(e.length<=8)return new Date(t,i-1,o);const n=parseInt(e.substring(8,10)),r=parseInt(e.substring(10,12)),s=parseInt(e.substring(12,14));return new Date(t,i-1,o,n,r,s)},R=(e,t)=>new Date(e.getTime()+6e4*t);class x extends Error{constructor(e,t){super(e),this.source=t,this.name=x.ErrorName}}x.ErrorName="ManagedBluelinkyError";const M=(t,i)=>{var o;return t instanceof e.HTTPError?new x(`${i?`@${i}: `:""}[${t.statusCode}] ${t.statusMessage} on [${t.method}] ${t.url} - ${JSON.stringify(t.body)}`,t):t instanceof e.ParseError?new x(`${i?`@${i}: `:""} Parsing error on [${t.method}] ${t.url} - ${JSON.stringify(null===(o=t.response)||void 0===o?void 0:o.body)}`,t):(Error,t)},V=(e,t)=>h(void 0,void 0,void 0,(function*(){const i=[];for(let o=0;o<e.length;o++)i.push(yield t(e[o],o,e));return i})),_=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));var H,U;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(H||(H={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(U||(U={}));class j extends ${constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=le.EU,this.serverRates={max:-1,current:-1},w.debug(`EU Vehicle ${this.vehicleConfig.id} created`)}start(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:L(le.EU,e.temperature),unit:e.unit}}));return w.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw M(e,"EuropeVehicle.start")}}))}stop(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return w.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw M(e,"EuropeVehicle.stop")}}))}lock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(w.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw M(e,"EuropeVehicle.lock")}}))}unlock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(w.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw M(e,"EuropeVehicle.unlock")}}))}fullStatus(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ue),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.vehicleStatusInfo;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.gpsDetail}return this._fullStatus=e,this._fullStatus}catch(e){throw M(e,"EuropeVehicle.fullStatus")}}))}status(e){var t,i,o,n,r,s,a,d,l,c,u,v,p,g,f,m,y,b,C,w,k,S,T,O,$,D,I,L,R,x,V,_,H,U,j,N,B,z,F,W,q,J,Y,G;return h(this,void 0,void 0,(function*(){const h=Object.assign(Object.assign({},ue),e),K=yield this.controller.getVehicleHttpService();try{const e=h.refresh?"":"/latest",M=this.updateRates(yield K.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)),Z=h.refresh?M.body.resMsg:M.body.resMsg.vehicleStatusInfo.vehicleStatus,Q={chassis:{hoodOpen:null==Z?void 0:Z.hoodOpen,trunkOpen:null==Z?void 0:Z.trunkOpen,locked:Z.doorLock,openDoors:{frontRight:!!(null===(t=null==Z?void 0:Z.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==Z?void 0:Z.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==Z?void 0:Z.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==Z?void 0:Z.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==Z?void 0:Z.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==Z?void 0:Z.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==Z?void 0:Z.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==Z?void 0:Z.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==Z?void 0:Z.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==Z?void 0:Z.airCtrlOn,steeringwheelHeat:!!(null==Z?void 0:Z.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==Z?void 0:Z.sideBackWindowHeat),defrost:null==Z?void 0:Z.defrost,temperatureSetpoint:E(le.EU,null===(c=null==Z?void 0:Z.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(u=null==Z?void 0:Z.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:Z.engine,accessory:null==Z?void 0:Z.acc,rangeGas:null!==(m=null===(f=null===(g=null===(p=null===(v=null==Z?void 0:Z.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==Z?void 0:Z.dte)||void 0===y?void 0:y.value,range:null===(k=null===(w=null===(C=null===(b=null==Z?void 0:Z.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===C?void 0:C.rangeByFuel)||void 0===w?void 0:w.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===($=null===(O=null===(T=null===(S=null==Z?void 0:Z.evStatus)||void 0===S?void 0:S.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===O?void 0:O.evModeRange)||void 0===$?void 0:$.value,plugedTo:null!==(I=null===(D=null==Z?void 0:Z.evStatus)||void 0===D?void 0:D.batteryPlugin)&&void 0!==I?I:A.UNPLUGED,charging:null===(L=null==Z?void 0:Z.evStatus)||void 0===L?void 0:L.batteryCharge,estimatedCurrentChargeDuration:null===(V=null===(x=null===(R=null==Z?void 0:Z.evStatus)||void 0===R?void 0:R.remainTime2)||void 0===x?void 0:x.atc)||void 0===V?void 0:V.value,estimatedFastChargeDuration:null===(U=null===(H=null===(_=null==Z?void 0:Z.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===H?void 0:H.etc1)||void 0===U?void 0:U.value,estimatedPortableChargeDuration:null===(B=null===(N=null===(j=null==Z?void 0:Z.evStatus)||void 0===j?void 0:j.remainTime2)||void 0===N?void 0:N.etc2)||void 0===B?void 0:B.value,estimatedStationChargeDuration:null===(W=null===(F=null===(z=null==Z?void 0:Z.evStatus)||void 0===z?void 0:z.remainTime2)||void 0===F?void 0:F.etc3)||void 0===W?void 0:W.value,batteryCharge12v:null===(q=null==Z?void 0:Z.battery)||void 0===q?void 0:q.batSoc,batteryChargeHV:null===(J=null==Z?void 0:Z.evStatus)||void 0===J?void 0:J.batteryStatus},lastupdate:(null==Z?void 0:Z.time)?P(null==Z?void 0:Z.time):null};return Q.engine.range||(Q.engine.rangeEV||Q.engine.rangeGas)&&(Q.engine.range=(null!==(Y=Q.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(G=Q.engine.rangeGas)&&void 0!==G?G:0)),this._status=h.parsed?Q:Z,this._status}catch(e){throw M(e,"EuropeVehicle.status")}}))}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,this._odometer}catch(e){throw M(e,"EuropeVehicle.odometer")}}))}location(){var e,t,i,o,n,r,s;return h(this,void 0,void 0,(function*(){const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw M(e,"EuropeVehicle.location")}}))}startCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return w.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw M(e,"EuropeVehicle.startCharge")}}))}stopCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return w.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw M(e,"EuropeVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,u;return h(this,void 0,void 0,(function*(){const h=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield h.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:N(e)}})),p=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return p?{start:null===(i=p.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=p.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:p.breakdown,driving:p.driving?{distance:null===(n=p.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=p.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=p.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=p.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:p.vehicleStatus?{tpms:(null===(d=p.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=p.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(c=p.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw M(e,"EuropeVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:N(e),setTripDay:i?B(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?P(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=P(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:R(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw M(e,"EuropeVehicle.history")}}))}driveHistory(e=H.DAY){var t,i;return h(this,void 0,void 0,(function*(){const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?P(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw M(e,"EuropeVehicle.history")}}))}getChargeTargets(){var e;return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),o=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return o&&Array.isArray(o)?o.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw M(e,"EuropeVehicle.getChargeTargets")}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!ce.includes(e.fast)||!ce.includes(e.slow))throw new x(`Charge target values are limited to ${ce.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:O.FAST,targetSOClevel:e.fast},{plugType:O.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw M(e,"EuropeVehicle.setChargeTargets")}}))}setNavigation(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw M(e,"EuropeVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function N(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function B(e){return e.day?`${N(e)}${e.day.toString().padStart(2,"0")}`:N(e)}class z{constructor(e){this.userConfig=e,this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0}}}function F(e,t=ne,i){return h(this,void 0,void 0,(function*(){const o=null!=i?i:new r.CookieJar;return yield l.default(e.endpoints.session,{cookieJar:o}),yield l.default(e.endpoints.language,{method:"POST",body:`{"lang":"${t}"}`,cookieJar:o}),o}))}const W={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 Mobile/15B92 Safari/604.1"},q=e=>e.catch((e=>"HTTPError"===e.name&&302===e.statusCode?e.response:Promise.reject(e)));class J{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanBrandAuthStrategy"}login(e,t){return h(this,void 0,void 0,(function*(){const i=yield F(this.environment,this.language,null==t?void 0:t.cookieJar),{body:{userId:o,serviceId:r}}=yield l.default(this.environment.endpoints.integration,{cookieJar:i,json:!0,headers:W}),s=this.environment.brandAuthUrl({language:this.language,userId:o,serviceId:r}),a=u.default.parse(s,!0),{body:d}=yield l.default(s,{cookieJar:i,headers:W}),c=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(d),h=null==c?void 0:c[1].replace(/&amp;/g,"&");if(!h)throw new Error("@EuropeanBrandAuthStrategy.login: cannot found the auth url from the form.");const v=new n.URLSearchParams;v.append("username",e.username),v.append("password",e.password),v.append("credentialId",""),v.append("rememberMe","on");const{headers:{location:p},body:g}=yield q(l.default.post(h,{cookieJar:i,body:v.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},W),followRedirect:!1}));if(!p){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(g);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication failed, cannot retrieve error message")}const f=yield l.default(p,{cookieJar:i,headers:W});let m=f.url,y=f.body;if(!m)throw new Error(`@EuropeanBrandAuthStrategy.login: after login redirection got stuck : ${y}`);if(m.includes("login-actions/required-action")){const e=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(y),t=/name="code" value="(.*)"/gi.exec(y);if(!e)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions url.");if(!t)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions code.");const o=e[1].startsWith("/")?`${a.protocol}//${a.host}${e[1]}`:e[1],r=new n.URLSearchParams;r.append("code",t[1]),r.append("accept","");const{headers:{location:s},body:d}=yield q(l.default.post(o,{cookieJar:i,body:r.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},W)}));if(!s){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(d);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication action failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication action failed, cannot retrieve error message")}const c=yield l.default(s,{cookieJar:i,headers:W});m=c.url,y=c.body}const{body:b,statusCode:C}=yield l.default.post(this.environment.endpoints.silentSignIn,{cookieJar:i,body:{intUserId:""},json:!0,headers:Object.assign(Object.assign({},W),{"ccsp-service-id":this.environment.clientId})});if(!b.redirectUrl)throw new Error(`@EuropeanBrandAuthStrategy.login: silent sign In didn't work, could not retrieve auth code. status: ${C}, body: ${JSON.stringify(b)}`);const{code:w}=u.default.parse(b.redirectUrl,!0).query;if(!w)throw new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument code in ${b.redirectUrl}.`);return{code:w,cookies:i}}))}}class Y{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanLegacyAuthStrategy"}login(e,t){return h(this,void 0,void 0,(function*(){const i=yield F(this.environment,this.language,null==t?void 0:t.cookieJar),{body:o,statusCode:n}=yield l.default(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:e.username,password:e.password},cookieJar:i});if(!o.redirectUrl)throw new Error(`@EuropeanLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${n}, body: ${JSON.stringify(o)}`);const{code:r}=u.default.parse(o.redirectUrl,!0).query;if(!r)throw new Error("@EuropeanLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:r,cookies:i}}))}}var G;!function(e){e.LOCAL="LOCAL",e.DISTANT="DISTANT"}(G||(G={}));class K extends z{constructor(e){var t;if(super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:_(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.userConfig.language=null!==(t=e.language)&&void 0!==t?t:ne,!oe.includes(this.userConfig.language))throw new Error(`The language code ${this.userConfig.language} is not managed. Only ${oe.join(", ")} are.`);this.session.deviceId=_(),this._environment=se(e),this.authStrategies={main:new J(this._environment,this.userConfig.language),fallback:new Y(this._environment,this.userConfig.language)},w.debug("EU Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return w.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!e)return w.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const t=new n.URLSearchParams;t.append("grant_type","refresh_token"),t.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),t.append("refresh_token",this.session.refreshToken);try{const e=yield l.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:t.toString(),throwHttpErrors:!1});if(200!==e.statusCode)return w.debug(`Refresh token failed: ${e.body}`),`Refresh token failed: ${e.body}`;const i=JSON.parse(e.body);this.session.accessToken="Bearer "+i.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+i.expires_in)}catch(e){throw M(e,"EuropeController.refreshAccessToken")}return w.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return h(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const e=yield l.default(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+e.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+e.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw M(e,"EuropeController.pin")}}))}login(){return h(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@EuropeController.login: username and password must be defined.");let e=null;try{w.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.main.name}`),e=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(t){w.error(`@EuropeController.login: sign in with ${this.authStrategies.main.name} failed with error ${t.toString()}`),w.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.fallback.name}`),e=yield this.authStrategies.fallback.login({password:this.userConfig.password,username:this.userConfig.username})}w.debug("@EuropeController.login: Authenticated properly with user and password");const t=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),i=yield l.default(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:t(64),pushType:"APNS",uuid:this.session.deviceId},json:!0});i&&(this.session.deviceId=i.body.resMsg.deviceId),w.debug("@EuropeController.login: Device registered");const o=new n.URLSearchParams;o.append("grant_type","authorization_code"),o.append("redirect_uri",this.environment.endpoints.redirectUri),o.append("code",e.code);const r=yield l.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:o.toString(),cookieJar:e.cookies});if(200!==r.statusCode)throw new Error(`@EuropeController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return w.debug("@EuropeController.login: Session defined properly"),"Login success"}catch(e){throw M(e,"EuropeController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const e=yield l.default(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield V(e.body.resMsg.vehicles,(e=>h(this,void 0,void 0,(function*(){const t=(yield l.default(`${this.environment.baseUrl}/api/v1/spa/vehicles/${e.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,i={nickname:e.nickname,name:e.vehicleName,regDate:e.regDate,brandIndicator:"H",id:e.vehicleId,vin:t.vinInfo[0].basic.vin,generation:t.vinInfo[0].basic.modelYear};return w.debug(`@EuropeController.getVehicles: Added vehicle ${i.id}`),new j(i,this)}))))}catch(e){throw M(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){var e;return h(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return h(this,void 0,void 0,(function*(){return yield this.checkControlToken(),l.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return h(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),l.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}const Z=Buffer.from("wLTVxwidmH8CfJYBWSnHD6E0huk0ozdiuygB4hLkM5XCgzAL1Dk5sE36d/bx5PFMQeU=","base64"),Q=Buffer.from("RFtoRq/vDXJmRndoZaZQyfOot7OrIqGVFj96iY2WL3yyH5Z/pUvlUhqmCxD2t+D65SQ=","base64"),X=new Map,ee=(e,t)=>()=>h(void 0,void 0,void 0,(function*(){var n;const{stamps:r,generated:s,frequency:a}=null!==(n=X.get(e))&&void 0!==n?n:yield((e,t=`https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/${e}.v2.json`)=>h(void 0,void 0,void 0,(function*(){if(t.startsWith("file://")){const[,e]=t.split("file://"),n=yield o.promisify(i.readFile)(e);return JSON.parse(n.toString("utf-8"))}const{body:n}=yield l.default(t,{json:!0});return X.set(e,n),n})))(e,t),d=new Date(s),c=Date.now()-d.getTime(),u=Math.floor(c/a);return u/(r.length-1)>=.9&&X.delete(e),r[Math.min(u,r.length-1)]})),te=(e,t)=>{const i=(e=>{switch(e){case"kia":return Z;case"hyundai":return Q}})(t);return()=>h(void 0,void 0,void 0,(function*(){const t=Buffer.from(`${e}:${Date.now()}`,"utf-8");return Promise.resolve(((e,t)=>{if(e.length!==t.length)throw new Error(`XOR Buffers are not the same size ${e.length} vs ${t.length}`);const i=Buffer.alloc(e.length);for(let o=0;o<i.length;o++)i.writeUInt8(e[o]^t[o],o);return i})(i,t).toString("base64"))}))},ie=({mode:e,appId:t,brand:i,stampsFile:o})=>{switch(e){case G.LOCAL:return te(t,i);case G.DISTANT:default:return ee(`${i}-${t}`,o)}},oe=["cs","da","nl","en","fi","fr","de","it","pl","hu","no","sk","es","sv"],ne="en",re=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),se=({brand:e,stampMode:t=G.DISTANT,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.hyundai.com:8080",o=`https://${i}`,n="6d477c38-3ca4-4cf3-9557-2a1929a94654",r="1eba27d2-9a5b-4eba-8ec7-97eb6c62fb51";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(re(o,n)),basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"414998006775",stamp:ie({appId:r,brand:"hyundai",mode:e,stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.hyundai.com/auth/realms/euhyundaiidm/protocol/openid-connect/auth?client_id=64621b96-0f0d-11ec-82a8-0242ac130003&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.kia.com:8080",o=`https://${i}`,n="fdc85c00-0a2f-4c64-bcb4-2cfb1500730a",r="a2b8469b-30a3-4361-8e13-6fceea8fbe74";return{brand:"kia",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(re(o,n)),basicToken:"Basic ZmRjODVjMDAtMGEyZi00YzY0LWJjYjQtMmNmYjE1MDA3MzBhOnNlY3JldA==",GCMSenderID:"345127537656",stamp:ie({appId:r,brand:"kia",mode:e,stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.kia.com/auth/realms/eukiaidm/protocol/openid-connect/auth?client_id=572e0304-5f8d-4b4c-9dd5-41aa84eed160&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}},ae=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}:443/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}:443/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),de=({brand:e})=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="prd.cn-ccapi.hyundai.com",t=`https://${e}`,i="72b3d019-5bc7-443d-a437-08f307cf06e2";return{brand:"hyundai",host:e,baseUrl:t,clientId:i,appId:"ed01581a-380f-48cd-83d4-ed1490c272d0",endpoints:Object.freeze(ae(t,i)),basicToken:"Basic NzJiM2QwMTktNWJjNy00NDNkLWE0MzctMDhmMzA3Y2YwNmUyOnNlY3JldA==",GCMSenderID:"414998006775",providerDeviceId:"59af09e554a9442ab8589c9500d04d2e",pushRegId:"1"}})());case"kia":return Object.freeze((()=>{const e="prd.cn-ccapi.kia.com",t=`https://${e}`,i="9d5df92a-06ae-435f-b459-8304f2efcc67";return{brand:"kia",host:e,baseUrl:t,clientId:i,appId:"eea8762c-adfc-4ee4-8d7a-6e2452ddf342",endpoints:Object.freeze(ae(t,i)),basicToken:"Basic OWQ1ZGY5MmEtMDZhZS00MzVmLWI0NTktODMwNGYyZWZjYzY3OnRzWGRrVWcwOEF2MlpaelhPZ1d6Snl4VVQ2eWVTbk5OUWtYWFBSZEtXRUFOd2wxcA==",GCMSenderID:"345127537656",providerDeviceId:"32dedba78045415b92db816e805ed47b",pushRegId:"ogc+GB5gom7zDEQjPhb3lP+bjjM=DG2rQ9Zuq0otwOU7n9y08LKjYpo="}})());default:throw new Error(`Constructor ${e} is not managed.`)}};var le;!function(e){e.US="US",e.CA="CA",e.EU="EU",e.CN="CN"}(le||(le={}));const ce=[50,60,70,80,90,100],ue={refresh:!1,parsed:!1};class he extends ${constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=le.US,w.debug(`US Vehicle ${this.vehicleConfig.regId} created`)}getDefaultHeaders(){return{access_token:this.controller.session.accessToken,client_id:this.controller.environment.clientId,Host:this.controller.environment.host,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}}fullStatus(){throw new Error("Method not implemented.")}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this._request(`/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get odometer reading!";const t=JSON.parse(e.body).enrolledVehicleDetails.find((e=>e.vehicleDetails.vin===this.vin()));return this._odometer={value:t.vehicleDetails.odometer,unit:0},this._odometer}))}location(){return h(this,void 0,void 0,(function*(){const e=yield this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get location!";const t=JSON.parse(e.body);return{latitude:t.coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}}))}start(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},{hvac:!1,duration:10,temperature:70,defrost:!1,heatedFeatures:!1,unit:"F"}),e);console.dir(t);const i={airCtrl:+t.hvac,airTemp:{unit:1,value:`${t.temperature}`},defrost:t.defrost,heating1:+t.heatedFeatures,seatHeaterVentInfo:null};return 200===(yield this._request("/ac/v2/evc/fatc/start",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"}),body:i,json:!0})).statusCode?"Vehicle started!":"Failed to start vehicle"}))}stop(){return h(this,void 0,void 0,(function*(){if(200===(yield this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"})})).statusCode)return"Vehicle stopped";throw"Failed to stop vehicle!"}))}status(e){var t,i,o,n,r,s,a,d,l,c,u,v,p,g,f,m,y,b,C;return h(this,void 0,void 0,(function*(){const h=Object.assign(Object.assign({},ue),e),w=yield this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:Object.assign({REFRESH:h.refresh.toString()},this.getDefaultHeaders())}),{vehicleStatus:k}=JSON.parse(w.body),S={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==k?void 0:k.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==k?void 0:k.tirePressureLamp)||void 0===r?void 0:r.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampRearRight),all:!!(null===(l=null==k?void 0:k.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(c=null==k?void 0:k.airTemp)||void 0===c?void 0:c.value,temperatureUnit:null===(u=null==k?void 0:k.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:null==k?void 0:k.engine,accessory:null==k?void 0:k.acc,range:(null===(f=null===(g=null===(p=null===(v=null==k?void 0:k.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.totalAvailableRange)||void 0===f?void 0:f.value)||(null===(m=null==k?void 0:k.dte)||void 0===m?void 0:m.value),charging:null===(y=null==k?void 0:k.evStatus)||void 0===y?void 0:y.batteryCharge,batteryCharge12v:null===(b=null==k?void 0:k.battery)||void 0===b?void 0:b.batSoc,batteryChargeHV:null===(C=null==k?void 0:k.evStatus)||void 0===C?void 0:C.batteryStatus},lastupdate:new Date(null==k?void 0:k.dateTime)};return this._status=h.parsed?S:k,this._status}))}unlock(){return h(this,void 0,void 0,(function*(){const e=new n.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Unlock successful":"Something went wrong!"}))}lock(){return h(this,void 0,void 0,(function*(){const e=new n.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Lock successful":"Something went wrong!"}))}startCharge(){return h(this,void 0,void 0,(function*(){if(200===(yield this._request(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return w.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}))}stopCharge(){return h(this,void 0,void 0,(function*(){if(200===(yield l.default(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return w.debug(`Send stop charge command to vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}))}_request(e,t){return h(this,void 0,void 0,(function*(){yield this.controller.refreshAccessToken(),t.headers.access_token=this.controller.session.accessToken;const i=yield l.default(`${this.controller.environment.baseUrl}/${e}`,Object.assign({throwHttpErrors:!1},t));return(null==i?void 0:i.body)&&w.debug(i.body),i}))}}class ve extends z{constructor(e){super(e),this.vehicles=[],this._environment=(e=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="api.telematics.hyundaiusa.com";return{brand:"hyundai",host:e,baseUrl:`https://${e}`,clientId:"m66129Bb-em93-SPAHYN-bZ91-am4540zp19920",clientSecret:"v558o935-6nne-423i-baa8"}})());case"kia":return Object.freeze((()=>{const e="api.owners.kia.com";return{brand:"kia",host:e,baseUrl:`https://${e}/apigw/v1/`,clientId:"MWAMOBILE",clientSecret:"98er-w34rf-ibf3-3f6h"}})());default:throw new Error(`Constructor ${e} is not managed.`)}})(e.brand),w.debug("US Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;try{if(this.session.refreshToken&&e){w.debug("refreshing token");const e=yield l.default(`${this.environment.baseUrl}/v2/ac/oauth/token/refresh`,{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_secret:this.environment.clientSecret,client_id:this.environment.clientId},json:!0});return w.debug(e.body),this.session.accessToken=e.body.access_token,this.session.refreshToken=e.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(e.body.expires_in)),w.debug("Token refreshed"),"Token refreshed"}return w.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh"}catch(e){throw M(e,"AmericanController.refreshAccessToken")}}))}login(){return h(this,void 0,void 0,(function*(){w.debug("Logging in to the API");try{const e=yield l.default(`${this.environment.baseUrl}/v2/ac/oauth/token`,{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_id:this.environment.clientId,client_secret:this.environment.clientSecret},json:!0});return w.debug(e.body),200!==e.statusCode?"login bad":(this.session.accessToken=e.body.access_token,this.session.refreshToken=e.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(e.body.expires_in)),"login good")}catch(e){throw M(e,"AmericanController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){try{const e=yield l.default(`${this.environment.baseUrl}/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:{access_token:this.session.accessToken,client_id:this.environment.clientId,Host:this.environment.host,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}}),t=JSON.parse(e.body);return void 0===t.enrolledVehicleDetails?(this.vehicles=[],this.vehicles):(this.vehicles=t.enrolledVehicleDetails.map((e=>{const t=e.vehicleDetails,i={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};return new he(i,this)})),this.vehicles)}catch(e){throw M(e,"AmericanController.getVehicles")}}))}}class pe extends ${constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=le.CA,this.timeOffset=-(new Date).getTimezoneOffset()/60,this._info=null,w.debug(`CA Vehicle ${this.vehicleConfig.id} created`)}fullStatus(){throw new Error("Method not implemented.")}status(e){var t,i,o,n,r,s,a,d,l,c,u,v,p,g,f,m,y;return h(this,void 0,void 0,(function*(){const h=Object.assign(Object.assign({},ue),e);w.debug("Begin status request, polling car",h.refresh);try{let e=null;if(h.useInfo)yield this.setInfo(h.refresh),this._info&&(e=this._info.status);else{const o=h.refresh?this.controller.environment.endpoints.remoteStatus:this.controller.environment.endpoints.status,n=yield this.request(o,{});if(e=null===(t=n.result)||void 0===t?void 0:t.status,null==n?void 0:n.error)throw null===(i=null==n?void 0:n.error)||void 0===i?void 0:i.errorDesc}w.debug(e);let b=null;return e&&(b={chassis:{hoodOpen:null==e?void 0:e.hoodOpen,trunkOpen:null==e?void 0:e.trunkOpen,locked:null==e?void 0:e.doorLock,openDoors:{frontRight:!!(null===(o=null==e?void 0:e.doorOpen)||void 0===o?void 0:o.frontRight),frontLeft:!!(null===(n=null==e?void 0:e.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==e?void 0:e.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(s=null==e?void 0:e.doorOpen)||void 0===s?void 0:s.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(a=null==e?void 0:e.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampRearLeft),frontLeft:!!(null===(d=null==e?void 0:e.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampFrontLeft),frontRight:!!(null===(l=null==e?void 0:e.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==e?void 0:e.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(u=null==e?void 0:e.tirePressureLamp)||void 0===u?void 0:u.tirePressureWarningLampAll)}},climate:{active:null==e?void 0:e.airCtrlOn,steeringwheelHeat:!!(null==e?void 0:e.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==e?void 0:e.sideBackWindowHeat),defrost:null==e?void 0:e.defrost,temperatureSetpoint:null===(v=null==e?void 0:e.airTemp)||void 0===v?void 0:v.value,temperatureUnit:null===(p=null==e?void 0:e.airTemp)||void 0===p?void 0:p.unit},engine:{ignition:null==e?void 0:e.engine,accessory:null==e?void 0:e.acc,range:null===(g=null==e?void 0:e.dte)||void 0===g?void 0:g.value,charging:null===(f=null==e?void 0:e.evStatus)||void 0===f?void 0:f.batteryCharge,batteryCharge12v:null===(m=null==e?void 0:e.battery)||void 0===m?void 0:m.batSoc,batteryChargeHV:null===(y=null==e?void 0:e.evStatus)||void 0===y?void 0:y.batteryStatus},lastupdate:P(null==e?void 0:e.lastStatusDate)}),this._status=h.parsed?b:e,this._status}catch(e){throw e.message}}))}lock(){return h(this,void 0,void 0,(function*(){w.debug("Begin lock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.lock,{},{pAuth:e}),"Lock successful"}catch(e){throw e.message}}))}unlock(){return h(this,void 0,void 0,(function*(){w.debug("Begin unlock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.unlock,{},{pAuth:e}),"Unlock successful"}catch(e){throw e.message}}))}start(e){var t,i,o,n,r;return h(this,void 0,void 0,(function*(){w.debug("Begin startClimate request");try{const s={hvacInfo:{airCtrl:null!==(t=e.hvac)&&void 0!==t&&t||null!==(i=e.defrost)&&void 0!==i&&i?1:0,defrost:null!==(o=e.defrost)&&void 0!==o&&o,heating1:e.heatedFeatures?1:0}},a=e.temperature;if(null!=a)s.hvacInfo.airTemp={value:L(le.CA,a),unit:0,hvacTempType:1};else if(null!==(n=e.hvac)&&void 0!==n&&n||null!==(r=e.defrost)&&void 0!==r&&r)throw"air temperature should be specified";const d=yield this.getPreAuth(),l=yield this.request(this.controller.environment.endpoints.start,s,{pAuth:d});return w.debug(l),l.responseHeader&&0===l.responseHeader.responseCode?"Vehicle started!":"Failed to start vehicle"}catch(e){throw e.message}}))}stop(){return h(this,void 0,void 0,(function*(){w.debug("Begin stop request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.stop,{pAuth:e})}catch(e){throw"error: "+e}}))}lights(e=!1){return h(this,void 0,void 0,(function*(){w.debug("Begin lights request with horn "+e);try{const t=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.hornlight,{horn:e},{pAuth:t})}catch(e){throw"error: "+e}}))}stopCharge(){return h(this,void 0,void 0,(function*(){w.debug("Begin stopCharge");const{stopCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}startCharge(){return h(this,void 0,void 0,(function*(){w.debug("Begin startCharge");const{startCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){if(w.debug("Begin setChargeTarget"),!ce.includes(e.fast)||!ce.includes(e.slow))throw new x(`Charge target values are limited to ${ce.join(", ")}`);const{setChargeTarget:t}=this.controller.environment.endpoints;try{const i=yield this.getPreAuth();return yield this.request(t,{pin:this.controller.userConfig.pin,pAuth:i,tsoc:[{plugType:O.FAST,level:e.fast},{plugType:O.SLOW,level:e.slow}]})}catch(e){throw"error: "+e}}))}odometer(){return h(this,void 0,void 0,(function*(){try{if(yield this.setInfo(),this._info)return{unit:this._info.vehicle.odometer,value:this._info.vehicle.odometerUnit};throw"error: no info"}catch(e){throw"error: "+e}}))}location(){return h(this,void 0,void 0,(function*(){w.debug("Begin locate request");try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.locate,{},{pAuth:e});return this._location=t.result,this._location}catch(e){throw"error: "+e}}))}getPreAuth(){return h(this,void 0,void 0,(function*(){w.info("Begin pre-authentication");try{return(yield this.request(this.controller.environment.endpoints.verifyPin,{})).result.pAuth}catch(e){throw"error: "+e}}))}request(e,t,i={}){return h(this,void 0,void 0,(function*(){w.debug(`[${e}] ${JSON.stringify(i)} ${JSON.stringify(t)}`),yield this.controller.refreshAccessToken();const o={method:"POST",json:!0,throwHttpErrors:!1,headers:Object.assign({from:this.controller.environment.origin,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},i),body:Object.assign({pin:this.userConfig.pin},t)};try{const t=yield l.default(e,o);return 0!=t.body.responseHeader.responseCode?t.body.responseHeader.responseDesc:t.body}catch(e){throw"error: "+e}}))}setInfo(e=!1){return h(this,void 0,void 0,(function*(){if(null===this._info||e)try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.vehicleInfo,{},{pAuth:e});this._info=t.result}catch(e){throw"error: "+e}}))}}class ge extends z{constructor(e){super(e),this.vehicles=[],this.timeOffset=-(new Date).getTimezoneOffset()/60,w.debug("CA Controller created"),this._environment=T(e.brand)}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;return w.debug("shouldRefreshToken: "+e.toString()),this.session.refreshToken&&e?(yield this.login(),w.debug("Token refreshed"),"Token refreshed"):(w.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh")}))}login(){return h(this,void 0,void 0,(function*(){w.info("Begin login request");try{const e=yield this.request(this.environment.endpoints.login,{loginId:this.userConfig.username,password:this.userConfig.password});return w.debug(e.result),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),"login good"}catch(e){return"error: "+e}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){w.info("Begin getVehicleList request");try{const e=(yield this.request(this.environment.endpoints.vehicleList,{})).result;return void 0===e.vehicles?(this.vehicles=[],this.vehicles):(e.vehicles.forEach((e=>{const t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};this.vehicles.push(new pe(t,this))})),this.vehicles)}catch(e){return w.debug(e),this.vehicles}}))}request(e,t,i={}){return h(this,void 0,void 0,(function*(){w.debug(`[${e}] ${JSON.stringify(i)} ${JSON.stringify(t)}`);try{const o=yield l.default(e,{method:"POST",json:!0,headers:Object.assign({from:this.environment.origin,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},i),body:Object.assign({},t)});if(0!=o.body.responseHeader.responseCode)throw o.body.responseHeader.responseDesc;return o.body}catch(e){throw M(e,"CanadianController")}}))}}var fe,me;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(fe||(fe={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(me||(me={}));class ye extends ${constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=le.CN,this.serverRates={max:-1,current:-1},w.debug(`CN Vehicle ${this.vehicleConfig.id} created`)}start(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:1,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:L(le.CN,e.temperature),unit:e.unit}}));return w.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw M(e,"ChinaVehicle.start")}}))}stop(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return w.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw M(e,"ChinaVehicle.stop")}}))}lock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(w.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw M(e,"ChinaVehicle.lock")}}))}unlock(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(w.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw M(e,"ChinaVehicle.unlock")}}))}fullStatus(e){return h(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ue),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.status;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg.status;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.coord}return this._fullStatus=e,this._fullStatus}catch(e){throw M(e,"ChinaVehicle.fullStatus")}}))}status(e){var t,i,o,n,r,s,a,d,l,c,u,v,p,g,f,m,y,b,C,w,k,S,T,O,$,D,I,L,R,x,V,_,H,U,j,N,B,z,F,W,q,J,Y,G;return h(this,void 0,void 0,(function*(){const h=Object.assign(Object.assign({},ue),e),K=yield this.controller.getVehicleHttpService();try{const e=h.refresh?"":"/latest",M=this.updateRates(yield K.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg.status,Z={chassis:{hoodOpen:null==M?void 0:M.hoodOpen,trunkOpen:null==M?void 0:M.trunkOpen,locked:M.doorLock,openDoors:{frontRight:!!(null===(t=null==M?void 0:M.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==M?void 0:M.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==M?void 0:M.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==M?void 0:M.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==M?void 0:M.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==M?void 0:M.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==M?void 0:M.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==M?void 0:M.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==M?void 0:M.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==M?void 0:M.airCtrlOn,steeringwheelHeat:!!(null==M?void 0:M.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==M?void 0:M.sideBackWindowHeat),defrost:null==M?void 0:M.defrost,temperatureSetpoint:E(le.EU,null===(c=null==M?void 0:M.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(u=null==M?void 0:M.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:M.engine,accessory:null==M?void 0:M.acc,rangeGas:null!==(m=null===(f=null===(g=null===(p=null===(v=null==M?void 0:M.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==M?void 0:M.dte)||void 0===y?void 0:y.value,range:null===(k=null===(w=null===(C=null===(b=null==M?void 0:M.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===C?void 0:C.rangeByFuel)||void 0===w?void 0:w.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===($=null===(O=null===(T=null===(S=null==M?void 0:M.evStatus)||void 0===S?void 0:S.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===O?void 0:O.evModeRange)||void 0===$?void 0:$.value,plugedTo:null!==(I=null===(D=null==M?void 0:M.evStatus)||void 0===D?void 0:D.batteryPlugin)&&void 0!==I?I:A.UNPLUGED,charging:null===(L=null==M?void 0:M.evStatus)||void 0===L?void 0:L.batteryCharge,estimatedCurrentChargeDuration:null===(V=null===(x=null===(R=null==M?void 0:M.evStatus)||void 0===R?void 0:R.remainTime2)||void 0===x?void 0:x.atc)||void 0===V?void 0:V.value,estimatedFastChargeDuration:null===(U=null===(H=null===(_=null==M?void 0:M.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===H?void 0:H.etc1)||void 0===U?void 0:U.value,estimatedPortableChargeDuration:null===(B=null===(N=null===(j=null==M?void 0:M.evStatus)||void 0===j?void 0:j.remainTime2)||void 0===N?void 0:N.etc2)||void 0===B?void 0:B.value,estimatedStationChargeDuration:null===(W=null===(F=null===(z=null==M?void 0:M.evStatus)||void 0===z?void 0:z.remainTime2)||void 0===F?void 0:F.etc3)||void 0===W?void 0:W.value,batteryCharge12v:null===(q=null==M?void 0:M.battery)||void 0===q?void 0:q.batSoc,batteryChargeHV:null===(J=null==M?void 0:M.evStatus)||void 0===J?void 0:J.batteryStatus},lastupdate:(null==M?void 0:M.time)?P(null==M?void 0:M.time):null};return Z.engine.range||(Z.engine.rangeEV||Z.engine.rangeGas)&&(Z.engine.range=(null!==(Y=Z.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(G=Z.engine.rangeGas)&&void 0!==G?G:0)),this._status=h.parsed?Z:M,this._status}catch(e){throw M(e,"ChinaVehicle.status")}}))}odometer(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.status.odometer,this._odometer}catch(e){throw M(e,"ChinaVehicle.odometer")}}))}location(){var e,t,i,o,n,r,s;return h(this,void 0,void 0,(function*(){const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw M(e,"ChinaVehicle.location")}}))}startCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return w.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw M(e,"ChinaVehicle.startCharge")}}))}stopCharge(){return h(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return w.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw M(e,"ChinaVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,u;return h(this,void 0,void 0,(function*(){const h=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield h.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:be(e)}})),p=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return p?{start:null===(i=p.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=p.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:p.breakdown,driving:p.driving?{distance:null===(n=p.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=p.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=p.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=p.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:p.vehicleStatus?{tpms:(null===(d=p.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=p.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(c=p.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw M(e,"ChinaVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:be(e),setTripDay:i?Ce(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?P(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=P(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:R(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw M(e,"ChinaVehicle.history")}}))}driveHistory(e=fe.DAY){var t,i;return h(this,void 0,void 0,(function*(){const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?P(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw M(e,"ChinaVehicle.history")}}))}getChargeTargets(){var e;return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),o=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return o&&Array.isArray(o)?o.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw M(e,"ChinaVehicle.getChargeTargets")}}))}setChargeTargets(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!ce.includes(e.fast)||!ce.includes(e.slow))throw new x(`Charge target values are limited to ${ce.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:O.FAST,targetSOClevel:e.fast},{plugType:O.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw M(e,"ChinaVehicle.setChargeTargets")}}))}setNavigation(e){return h(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw M(e,"ChinaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function be(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function Ce(e){return e.day?`${be(e)}${e.day.toString().padStart(2,"0")}`:be(e)}class we{constructor(e){this.environment=e}get name(){return"ChineseLegacyAuthStrategy"}login(e,t){return h(this,void 0,void 0,(function*(){const i=yield function(e,t){return h(this,void 0,void 0,(function*(){const i=null!=t?t:new r.CookieJar;return yield l.default(e.endpoints.session,{cookieJar:i}),yield l.default(e.endpoints.language,{method:"POST",body:'{"lang":"zh"}',cookieJar:i}),i}))}(this.environment,null==t?void 0:t.cookieJar),{body:o,statusCode:n}=yield l.default(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:e.username,password:e.password},cookieJar:i});if(!o.redirectUrl)throw new Error(`@ChineseLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${n}, body: ${JSON.stringify(o)}`);const{code:s}=u.default.parse(o.redirectUrl,!0).query;if(!s)throw new Error("@ChineseLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:s,cookies:i}}))}}class ke extends z{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:_(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=_(),this._environment=de(e),this.authStrategies={main:new we(this._environment)},w.debug("CN Controller created")}get environment(){return this._environment}refreshAccessToken(){return h(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return w.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!e)return w.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const t=new n.URLSearchParams;t.append("grant_type","refresh_token"),t.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),t.append("refresh_token",this.session.refreshToken);try{const e=yield l.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:t.toString(),throwHttpErrors:!1});if(200!==e.statusCode)return w.debug(`Refresh token failed: ${e.body}`),`Refresh token failed: ${e.body}`;const i=JSON.parse(e.body);this.session.accessToken="Bearer "+i.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+i.expires_in)}catch(e){throw M(e,"ChinaController.refreshAccessToken")}return w.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return h(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const e=yield l.default(`${this.environment.baseUrl}/api/v1/user/pin?token=`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+e.body.controlToken,w.debug(`controlToken is : ${this.session.controlToken}`),this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+e.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw M(e,"ChinaController.pin")}}))}login(){return h(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@ChinaController.login: username and password must be defined.");let e=null;try{w.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),e=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(t){w.error(`@ChinaController.login: sign in with ${this.authStrategies.main.name} failed with error ${t.toString()}`),w.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),e=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}w.debug("@ChinaController.login: Authenticated properly with user and password");const t=yield l.default(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId},body:{pushRegId:this.environment.pushRegId,providerDeviceId:this.environment.providerDeviceId,pushType:"GCM",uuid:_()},json:!0});t&&(this.session.deviceId=t.body.resMsg.deviceId),w.debug("@ChinaController.login: Device registered");const i=new n.URLSearchParams;i.append("grant_type","authorization_code"),i.append("redirect_uri",this.environment.endpoints.redirectUri),i.append("code",e.code);const o=yield l.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:i.toString(),cookieJar:e.cookies});if(200!==o.statusCode)throw new Error(`@ChinaController.login: Could not manage to get token: ${o.body}`);if(o){const e=JSON.parse(o.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return w.debug("@ChinaController.login: Session defined properly"),w.debug(`accessToken is ${this.session.accessToken}\n refreshToken is ${this.session.refreshToken}\n tokenExpiresAt : ${this.session.tokenExpiresAt}`),"Login success"}catch(e){throw M(e,"ChinaController.login")}}))}logout(){return h(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return h(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const e=yield l.default(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0});this.vehicles=yield V(e.body.resMsg.vehicles,(e=>h(this,void 0,void 0,(function*(){const t=(yield l.default(`${this.environment.baseUrl}/api/v1/spa/vehicles/${e.vehicleId}/profile`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0})).body.resMsg,i={nickname:e.nickname,name:e.vehicleName,regDate:e.regDate,brandIndicator:"H",id:e.vehicleId,vin:t.vinInfo[0].basic.vin,generation:t.vinInfo[0].basic.modelYear};return w.debug(`@ChineseController.getVehicles: Added vehicle ${i.id}`),new ye(i,this)}))))}catch(e){throw M(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){var e;return h(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return h(this,void 0,void 0,(function*(){return yield this.checkControlToken(),l.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,AuthorizationCCSP:this.session.controlToken,"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c"}),json:!0})}))}getApiHttpService(){return h(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),l.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign({},this.defaultHeaders),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(0),"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c","ccsp-application-id":this.environment.appId,"Content-Type":"application/json","User-Agent":"okhttp/4.4.0"}}}const Se={username:"",password:"",region:le.US,brand:"hyundai",autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0};class Te extends s.EventEmitter{constructor(e){switch(super(),this.vehicles=[],this.config=Object.assign(Object.assign({},Se),e),e.region){case le.EU:this.controller=new K(this.config);break;case le.US:this.controller=new ve(this.config);break;case le.CA:this.controller=new ge(this.config);break;case le.CN:this.controller=new ke(this.config);break;default:throw new Error("Your region is not supported yet.")}void 0===e.autoLogin&&(this.config.autoLogin=!0),this.onInit()}on(e,t){return super.on(e,t)}onInit(){this.config.autoLogin&&(w.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())}login(){return h(this,void 0,void 0,(function*(){try{const e=yield this.controller.login();return this.vehicles=yield this.getVehicles(),w.debug(`Found ${this.vehicles.length} on the account`),this.emit("ready",this.vehicles),e}catch(e){return this.emit("error",e),e.message}}))}getVehicles(){return h(this,void 0,void 0,(function*(){return(yield this.controller.getVehicles())||[]}))}getVehicle(e){try{const t=this.vehicles.find((t=>t.vin().toLowerCase()===e.toLowerCase()));if(!t&&this.vehicles.length>0)throw new Error(`Could not find vehicle with id: ${e}`);return t}catch(t){throw new Error(`Vehicle not found: ${e}!`)}}refreshAccessToken(){return h(this,void 0,void 0,(function*(){return this.controller.refreshAccessToken()}))}logout(){return h(this,void 0,void 0,(function*(){return this.controller.logout()}))}getSession(){return this.controller.session}get cachedVehicles(){var e;return null!==(e=this.vehicles)&&void 0!==e?e:[]}}module.exports=Te;
