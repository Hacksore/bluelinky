/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
import e,{HTTPError as t,ParseError as i}from"got";import*as o from"winston";import{readFile as n}from"fs";import{promisify as r}from"util";import s,{URLSearchParams as a}from"url";import{CookieJar as d}from"tough-cookie";import l from"node:crypto";import{Agent as c,fetch as h}from"undici";import{EventEmitter as u}from"events";function v(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const p=process.env.LOG_LEVEL||"info",{colorize:g,json:f,combine:m,timestamp:y,printf:b}=o.format,C=b((({level:e,message:t,timestamp:i})=>(["array","object"].includes(typeof t)&&(t=JSON.stringify(t,null,2)),`[${i}] ${e}: ${t}`))),w=m(y({format:"YYYY-MM-DD HH:mm:ss"}),g(),f(),C),k=o.createLogger({format:w,level:p,transports:[new o.transports.Console({})]}),T=e=>({login:`${e}/tods/api/lgn`,logout:`${e}/tods/api/lgout`,vehicleList:`${e}/tods/api/vhcllst`,vehicleInfo:`${e}/tods/api/sltvhcl`,status:`${e}/tods/api/lstvhclsts`,remoteStatus:`${e}/tods/api/rltmvhclsts`,lock:`${e}/tods/api/drlck`,unlock:`${e}/tods/api/drulck`,start:`${e}/tods/api/evc/rfon`,stop:`${e}/tods/api/evc/rfoff`,startCharge:`${e}/tods/api/evc/rcstrt`,stopCharge:`${e}/tods/api/evc/rcstp`,setChargeTarget:`${e}/tods/api/evc/setsoc`,locate:`${e}/tods/api/fndmcr`,hornlight:`${e}/tods/api/hornlight`,verifyAccountToken:`${e}/tods/api/vrfyacctkn`,verifyPin:`${e}/tods/api/vrfypin`,verifyToken:`${e}/tods/api/vrfytnc`}),S=e=>{const t=`https://${e}`;return{host:e,baseUrl:t,origin:"SPA",endpoints:Object.freeze(T(t))}},A=e=>{switch(e){case"hyundai":return Object.freeze(Object.assign({brand:"hyundai"},S("mybluelink.ca")));case"kia":return Object.freeze(Object.assign({brand:"hyundai"},S("kiaconnect.ca")));default:throw new Error(`Constructor ${e} is not managed.`)}},O=Buffer.from("IDbMgWBXgic4MAyMgf5PFFRAdGX5O3IyC3uvN3scCs0gDpTFDuyvBorlAH9JMM2/hys=","base64"),$=Buffer.from("V60WkEmyRQaAfrBF1623/7QL62MjLVbCHdItGzQ1g5T/hkmKmMVTaMHv4cKGzgD3kfc=","base64"),D=Buffer.from("wLTVxwidmH8CfJYBWSnHD6E0huk0ozdiuygB4hLkM5XCgzAL1Dk5sE36d/bx5PFMQeU=","base64"),I=Buffer.from("RFtoRq/vDXJmRndoZaZQyfOot7OrIqGVFj96iY2WL3yyH5Z/pUvlUhqmCxD2t+D65SQ=","base64");var E;!function(e){e.LOCAL="LOCAL",e.DISTANT="DISTANT"}(E||(E={}));const L=new Map,M=(t,i,o)=>()=>v(void 0,void 0,void 0,(function*(){var s;const{stamps:a,generated:d,frequency:l}=null!==(s=L.get(t))&&void 0!==s?s:yield((t,i,...o)=>v(void 0,[t,i,...o],void 0,(function*(t,i,o=`${i}${t}.v2.json`){if(o.startsWith("file://")){const[,e]=o.split("file://"),t=yield r(n)(e);return JSON.parse(t.toString("utf-8"))}const{body:s}=yield e(o,{json:!0});return L.set(t,s),s})))(t,i,o),c=new Date(d),h=Date.now()-c.getTime(),u=Math.floor(h/l);return u/(a.length-1)>=.9&&L.delete(t),a[Math.min(u,a.length-1)]})),P=(e,t,i)=>{const o=((e,t)=>{switch(t){case F.AU:return"kia"===e?O:$;case F.EU:return"kia"===e?D:I;default:throw new Error("Local stamp generation is only supported in Australia and Europe")}})(t,i);return()=>v(void 0,void 0,void 0,(function*(){const t=Buffer.from(`${e}:${Date.now()}`,"utf-8");return Promise.resolve(((e,t)=>{if(e.length!==t.length)throw new Error(`XOR Buffers are not the same size ${e.length} vs ${t.length}`);const i=Buffer.alloc(e.length);for(let o=0;o<i.length;o++)i.writeUInt8(e[o]^t[o],o);return i})(o,t).toString("base64"))}))},R=({appId:e,brand:t,mode:i,region:o,stampHost:n,stampsFile:r})=>{switch(i){case E.LOCAL:return P(e,t,o);case E.DISTANT:default:return M(`${t}-${e}`,n,r)}},V=["cs","da","nl","en","fi","fr","de","it","pl","hu","no","sk","es","sv"],x=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),H=({brand:e,stampMode:t=E.DISTANT,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.hyundai.com:8080",o=`https://${i}`,n="6d477c38-3ca4-4cf3-9557-2a1929a94654",r="1eba27d2-9a5b-4eba-8ec7-97eb6c62fb51";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(x(o,n)),basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"414998006775",stamp:R({appId:r,brand:"hyundai",mode:e,region:F.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.hyundai.com/auth/realms/euhyundaiidm/protocol/openid-connect/auth?client_id=64621b96-0f0d-11ec-82a8-0242ac130003&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.kia.com:8080",o=`https://${i}`,n="fdc85c00-0a2f-4c64-bcb4-2cfb1500730a",r="a2b8469b-30a3-4361-8e13-6fceea8fbe74";return{brand:"kia",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(x(o,n)),basicToken:"Basic ZmRjODVjMDAtMGEyZi00YzY0LWJjYjQtMmNmYjE1MDA3MzBhOnNlY3JldA==",GCMSenderID:"345127537656",stamp:R({appId:r,brand:"kia",mode:e,region:F.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.kia.com/auth/realms/eukiaidm/protocol/openid-connect/auth?client_id=572e0304-5f8d-4b4c-9dd5-41aa84eed160&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}},U=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}:443/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}:443/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),_=({brand:e})=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="prd.cn-ccapi.hyundai.com",t=`https://${e}`,i="72b3d019-5bc7-443d-a437-08f307cf06e2";return{brand:"hyundai",host:e,baseUrl:t,clientId:i,appId:"ed01581a-380f-48cd-83d4-ed1490c272d0",endpoints:Object.freeze(U(t,i)),basicToken:"Basic NzJiM2QwMTktNWJjNy00NDNkLWE0MzctMDhmMzA3Y2YwNmUyOnNlY3JldA==",GCMSenderID:"414998006775",providerDeviceId:"59af09e554a9442ab8589c9500d04d2e",pushRegId:"1"}})());case"kia":return Object.freeze((()=>{const e="prd.cn-ccapi.kia.com",t=`https://${e}`,i="9d5df92a-06ae-435f-b459-8304f2efcc67";return{brand:"kia",host:e,baseUrl:t,clientId:i,appId:"eea8762c-adfc-4ee4-8d7a-6e2452ddf342",endpoints:Object.freeze(U(t,i)),basicToken:"Basic OWQ1ZGY5MmEtMDZhZS00MzVmLWI0NTktODMwNGYyZWZjYzY3OnRzWGRrVWcwOEF2MlpaelhPZ1d6Snl4VVQ2eWVTbk5OUWtYWFBSZEtXRUFOd2wxcA==",GCMSenderID:"345127537656",providerDeviceId:"32dedba78045415b92db816e805ed47b",pushRegId:"ogc+GB5gom7zDEQjPhb3lP+bjjM=DG2rQ9Zuq0otwOU7n9y08LKjYpo="}})());default:throw new Error(`Constructor ${e} is not managed.`)}},j=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&client_id=${t}&redirect_uri=${encodeURIComponent(`${e}/api/v1/user/oauth2/redirect`)}&lang=en`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),N=({brand:e,stampMode:t=E.LOCAL,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.hyundai.com.au:8080",o=`https://${i}`,n="855c72df-dfd7-4230-ab03-67cbf902bb1c",r="f9ccfdac-a48d-4c57-bd32-9116963c24ed";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(j(o,n)),basicToken:"Basic ODU1YzcyZGYtZGZkNy00MjMwLWFiMDMtNjdjYmY5MDJiYjFjOmU2ZmJ3SE0zMllOYmhRbDBwdmlhUHAzcmY0dDNTNms5MWVjZUEzTUpMZGJkVGhDTw==",stamp:R({appId:r,brand:"hyundai",mode:e,region:F.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.kia.com.au:8082",o=`https://${i}`,n="8acb778a-b918-4a8d-8624-73a0beb64289",r="4ad4dcde-be23-48a8-bc1c-91b94f5c06f8";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(j(o,n)),basicToken:"Basic OGFjYjc3OGEtYjkxOC00YThkLTg2MjQtNzNhMGJlYjY0Mjg5OjdTY01NbTZmRVlYZGlFUEN4YVBhUW1nZVlkbFVyZndvaDRBZlhHT3pZSVMyQ3U5VA==",stamp:R({appId:r,brand:"kia",mode:e,region:F.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}};var F;!function(e){e.US="US",e.CA="CA",e.EU="EU",e.CN="CN",e.AU="AU"}(F||(F={}));const z=[50,60,70,80,90,100],B={refresh:!1,parsed:!1};class Y{constructor(e,t){this.vehicleConfig=e,this.controller=t,this._fullStatus=null,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:F.EU,brand:"hyundai",autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}vin(){return this.vehicleConfig.vin}name(){return this.vehicleConfig.name}nickname(){return this.vehicleConfig.nickname}id(){return this.vehicleConfig.id}brandIndicator(){return this.vehicleConfig.brandIndicator}}class J extends Y{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=F.US,k.debug(`US Vehicle ${this.vehicleConfig.regId} created`)}getDefaultHeaders(){return{access_token:this.controller.session.accessToken,client_id:this.controller.environment.clientId,Host:this.controller.environment.host,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}}fullStatus(){throw new Error("Method not implemented.")}odometer(){return v(this,void 0,void 0,(function*(){const e=yield this._request(`/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get odometer reading!";const t=JSON.parse(e.body).enrolledVehicleDetails.find((e=>e.vehicleDetails.vin===this.vin()));return this._odometer={value:t.vehicleDetails.odometer,unit:0},this._odometer}))}location(){return v(this,void 0,void 0,(function*(){const e=yield this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get location!";const t=JSON.parse(e.body);return{latitude:t.coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}}))}start(e){return v(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},{hvac:!1,duration:10,temperature:70,defrost:!1,heatedFeatures:!1,unit:"F"}),e),i={Ims:0,airCtrl:+t.hvac,airTemp:{unit:1,value:`${t.temperature}`},defrost:t.defrost,heating1:+t.heatedFeatures,igniOnDuration:t.duration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin};return 200===(yield this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"}),body:i,json:!0})).statusCode?"Vehicle started!":"Failed to start vehicle"}))}stop(){return v(this,void 0,void 0,(function*(){if(200===(yield this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"})})).statusCode)return"Vehicle stopped";throw"Failed to stop vehicle!"}))}status(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b;const C=Object.assign(Object.assign({},B),e),w=yield this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:Object.assign({REFRESH:C.refresh.toString()},this.getDefaultHeaders())}),{vehicleStatus:k}=JSON.parse(w.body),T={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==k?void 0:k.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==k?void 0:k.tirePressureLamp)||void 0===r?void 0:r.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampRearRight),all:!!(null===(l=null==k?void 0:k.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(c=null==k?void 0:k.airTemp)||void 0===c?void 0:c.value,temperatureUnit:null===(h=null==k?void 0:k.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:null==k?void 0:k.engine,accessory:null==k?void 0:k.acc,range:(null===(g=null===(p=null===(v=null===(u=null==k?void 0:k.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.totalAvailableRange)||void 0===g?void 0:g.value)||(null===(f=null==k?void 0:k.dte)||void 0===f?void 0:f.value),charging:null===(m=null==k?void 0:k.evStatus)||void 0===m?void 0:m.batteryCharge,batteryCharge12v:null===(y=null==k?void 0:k.battery)||void 0===y?void 0:y.batSoc,batteryChargeHV:null===(b=null==k?void 0:k.evStatus)||void 0===b?void 0:b.batteryStatus},lastupdate:new Date(null==k?void 0:k.dateTime)};return this._status=C.parsed?T:k,this._status}))}unlock(){return v(this,void 0,void 0,(function*(){const e=new a;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Unlock successful":"Something went wrong!"}))}lock(){return v(this,void 0,void 0,(function*(){const e=new a;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Lock successful":"Something went wrong!"}))}startCharge(){return v(this,void 0,void 0,(function*(){if(200===(yield this._request(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return k.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}))}stopCharge(){return v(this,void 0,void 0,(function*(){if(200===(yield e(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return k.debug(`Send stop charge command to vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}))}_request(t,i){return v(this,void 0,void 0,(function*(){yield this.controller.refreshAccessToken(),i.headers.access_token=this.controller.session.accessToken;const o=yield e(`${this.controller.environment.baseUrl}/${t}`,Object.assign({throwHttpErrors:!1},i));return(null==o?void 0:o.body)&&k.debug(o.body),o}))}}class W{constructor(e){this.userConfig=e,this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0}}}class G extends Error{constructor(e,t){super(e),this.source=t,this.name=G.ErrorName}}G.ErrorName="ManagedBluelinkyError";const q=(e,o)=>{var n;return e instanceof t?new G(`${o?`@${o}: `:""}[${e.statusCode}] ${e.statusMessage} on [${e.method}] ${e.url} - ${JSON.stringify(e.body)}`,e):e instanceof i?new G(`${o?`@${o}: `:""} Parsing error on [${e.method}] ${e.url} - ${JSON.stringify(null===(n=e.response)||void 0===n?void 0:n.body)}`,e):(Error,e)},Z=(e,t)=>v(void 0,void 0,void 0,(function*(){const i=[];for(let o=0;o<e.length;o++)i.push(yield t(e[o],o,e));return i})),K=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));class Q extends W{constructor(e){super(e),this.vehicles=[],this._environment=(e=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="api.telematics.hyundaiusa.com";return{brand:"hyundai",host:e,baseUrl:`https://${e}`,clientId:"m66129Bb-em93-SPAHYN-bZ91-am4540zp19920",clientSecret:"v558o935-6nne-423i-baa8"}})());case"kia":return Object.freeze((()=>{const e="api.owners.kia.com";return{brand:"kia",host:e,baseUrl:`https://${e}/apigw/v1/`,clientId:"MWAMOBILE",clientSecret:"98er-w34rf-ibf3-3f6h"}})());default:throw new Error(`Constructor ${e} is not managed.`)}})(e.brand),k.debug("US Controller created")}get environment(){return this._environment}refreshAccessToken(){return v(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;try{if(this.session.refreshToken&&t){k.debug("refreshing token");const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token/refresh`,{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_secret:this.environment.clientSecret,client_id:this.environment.clientId},json:!0});return k.debug(t.body),this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),k.debug("Token refreshed"),"Token refreshed"}return k.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh"}catch(e){throw q(e,"AmericanController.refreshAccessToken")}}))}login(){return v(this,void 0,void 0,(function*(){k.debug("Logging in to the API");try{const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token`,{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_id:this.environment.clientId,client_secret:this.environment.clientSecret},json:!0});return k.debug(t.body),200!==t.statusCode?"login bad":(this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),"login good")}catch(e){throw q(e,"AmericanController.login")}}))}logout(){return v(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return v(this,void 0,void 0,(function*(){try{const t=yield e(`${this.environment.baseUrl}/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:{access_token:this.session.accessToken,client_id:this.environment.clientId,Host:this.environment.host,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}}),i=JSON.parse(t.body);return void 0===i.enrolledVehicleDetails?(this.vehicles=[],this.vehicles):(this.vehicles=i.enrolledVehicleDetails.map((e=>{const t=e.vehicleDetails,i={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};return new J(i,this)})),this.vehicles)}catch(e){throw q(e,"AmericanController.getVehicles")}}))}}var X,ee,te;!function(e){e[e.UNPLUGED=0]="UNPLUGED",e[e.FAST=1]="FAST",e[e.PORTABLE=2]="PORTABLE",e[e.STATION=3]="STATION"}(X||(X={})),function(e){e[e.FAST=0]="FAST",e[e.SLOW=1]="SLOW"}(ee||(ee={})),function(e){e[e.CLOSED=0]="CLOSED",e[e.OPEN=1]="OPEN",e[e.VENTILATION=2]="VENTILATION"}(te||(te={}));const ie=(e,t,i)=>{const o=[];for(let n=e;n<=t;n+=i)o.push(n);return o},oe={EU:{start:14,end:30,step:.5},CA:{start:16,end:32,step:.5},CN:{start:14,end:30,step:.5},AU:{start:17,end:27,step:.5}},ne=(e,t)=>{const{start:i,end:o,step:n}=oe[e],r=ie(i,o,n).indexOf(t);return`${("0x"+r.toString(16).substr(-4).toUpperCase()).split("x")[1].toUpperCase()}H`.padStart(3,"0")},re=(e,t)=>{const{start:i,end:o,step:n}=oe[e];return ie(i,o,n)[parseInt(t,16)]},se=e=>{const t=parseInt(e.substring(0,4)),i=parseInt(e.substring(4,6));if(e.length<=6)return new Date(t,i-1);const o=parseInt(e.substring(6,8));if(e.length<=8)return new Date(t,i-1,o);const n=parseInt(e.substring(8,10)),r=parseInt(e.substring(10,12)),s=parseInt(e.substring(12,14));return new Date(t,i-1,o,n,r,s)},ae=(e,t)=>new Date(e.getTime()+6e4*t);var de,le;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(de||(de={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(le||(le={}));class ce extends Y{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=F.EU,this.serverRates={max:-1,current:-1},k.debug(`EU Vehicle ${this.vehicleConfig.id} created`)}start(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ne(F.EU,e.temperature),unit:e.unit}}));return k.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw q(e,"EuropeVehicle.start")}}))}stop(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return k.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw q(e,"EuropeVehicle.stop")}}))}lock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw q(e,"EuropeVehicle.lock")}}))}unlock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw q(e,"EuropeVehicle.unlock")}}))}fullStatus(e){return v(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},B),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.vehicleStatusInfo,o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/ccs2/carstatus/latest`));if(null!=o.body.resMsg.state.Vehicle&&(e.ccs2Status=o.body.resMsg),t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.gpsDetail}return this._fullStatus=e,this._fullStatus}catch(e){throw q(e,"EuropeVehicle.fullStatus")}}))}status(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,O,$,D,I,E,L,M,P,R,V,x,H,U,_,j,N,z,Y,J;const W=Object.assign(Object.assign({},B),e),G=yield this.controller.getVehicleHttpService();try{const e=W.refresh?"":"/latest",B=this.updateRates(yield G.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)),q=W.refresh?B.body.resMsg:B.body.resMsg.vehicleStatusInfo.vehicleStatus,Z={chassis:{hoodOpen:null==q?void 0:q.hoodOpen,trunkOpen:null==q?void 0:q.trunkOpen,locked:q.doorLock,openDoors:{frontRight:!!(null===(t=null==q?void 0:q.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==q?void 0:q.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==q?void 0:q.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==q?void 0:q.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==q?void 0:q.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==q?void 0:q.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==q?void 0:q.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==q?void 0:q.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==q?void 0:q.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==q?void 0:q.airCtrlOn,steeringwheelHeat:!!(null==q?void 0:q.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==q?void 0:q.sideBackWindowHeat),defrost:null==q?void 0:q.defrost,temperatureSetpoint:re(F.EU,null===(c=null==q?void 0:q.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==q?void 0:q.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:q.engine,accessory:null==q?void 0:q.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==q?void 0:q.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==q?void 0:q.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==q?void 0:q.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(S=null===(T=null===(k=null==q?void 0:q.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===S?void 0:S.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==q?void 0:q.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:X.UNPLUGED,charging:null===(D=null==q?void 0:q.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==q?void 0:q.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(R=null===(P=null===(M=null==q?void 0:q.evStatus)||void 0===M?void 0:M.remainTime2)||void 0===P?void 0:P.etc1)||void 0===R?void 0:R.value,estimatedPortableChargeDuration:null===(H=null===(x=null===(V=null==q?void 0:q.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===H?void 0:H.value,estimatedStationChargeDuration:null===(j=null===(_=null===(U=null==q?void 0:q.evStatus)||void 0===U?void 0:U.remainTime2)||void 0===_?void 0:_.etc3)||void 0===j?void 0:j.value,batteryCharge12v:null===(N=null==q?void 0:q.battery)||void 0===N?void 0:N.batSoc,batteryChargeHV:null===(z=null==q?void 0:q.evStatus)||void 0===z?void 0:z.batteryStatus},lastupdate:(null==q?void 0:q.time)?se(null==q?void 0:q.time):null};return Z.engine.range||(Z.engine.rangeEV||Z.engine.rangeGas)&&(Z.engine.range=(null!==(Y=Z.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(J=Z.engine.rangeGas)&&void 0!==J?J:0)),this._status=W.parsed?Z:q,this._status}catch(e){throw q(e,"EuropeVehicle.status")}}))}odometer(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,this._odometer}catch(e){throw q(e,"EuropeVehicle.odometer")}}))}location(){return v(this,void 0,void 0,(function*(){var e,t,i,o,n,r,s;const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw q(e,"EuropeVehicle.location")}}))}startCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw q(e,"EuropeVehicle.startCharge")}}))}stopCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw q(e,"EuropeVehicle.stopCharge")}}))}monthlyReport(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:he(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw q(e,"EuropeVehicle.monthyReports")}}))}tripInfo(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:he(e),setTripDay:i?ue(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?se(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=se(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ae(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw q(e,"EuropeVehicle.history")}}))}driveHistory(){return v(this,arguments,void 0,(function*(e=de.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?se(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw q(e,"EuropeVehicle.history")}}))}getChargeTargets(){return v(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw q(e,"EuropeVehicle.getChargeTargets")}}))}setChargeTargets(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!z.includes(e.fast)||!z.includes(e.slow))throw new G(`Charge target values are limited to ${z.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:ee.FAST,targetSOClevel:e.fast},{plugType:ee.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw q(e,"EuropeVehicle.setChargeTargets")}}))}setNavigation(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw q(e,"EuropeVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function he(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function ue(e){return e.day?`${he(e)}${e.day.toString().padStart(2,"0")}`:he(e)}function ve(t){return v(this,arguments,void 0,(function*(t,i="en",o){const n=null!=o?o:new d;return yield e(t.endpoints.session,{cookieJar:n}),yield e(t.endpoints.language,{method:"POST",body:`{"lang":"${i}"}`,cookieJar:n}),n}))}const pe={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 Mobile/15B92 Safari/604.1"},ge=e=>e.catch((e=>"HTTPError"===e.name&&302===e.statusCode?e.response:Promise.reject(e)));class fe{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanBrandAuthStrategy"}login(t,i){return v(this,void 0,void 0,(function*(){const o=yield ve(this.environment,this.language,null==i?void 0:i.cookieJar),{body:{userId:n,serviceId:r}}=yield e(this.environment.endpoints.integration,{cookieJar:o,json:!0,headers:pe}),d=this.environment.brandAuthUrl({language:this.language,userId:n,serviceId:r}),l=s.parse(d,!0),{body:c}=yield e(d,{cookieJar:o,headers:pe}),h=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(c),u=null==h?void 0:h[1].replace(/&amp;/g,"&");if(!u)throw new Error("@EuropeanBrandAuthStrategy.login: cannot found the auth url from the form.");const v=new a;v.append("username",t.username),v.append("password",t.password),v.append("credentialId",""),v.append("rememberMe","on");const{headers:{location:p},body:g}=yield ge(e.post(u,{cookieJar:o,body:v.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},pe),followRedirect:!1}));if(!p){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(g);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication failed, cannot retrieve error message")}const f=yield e(p,{cookieJar:o,headers:pe});let m=f.url,y=f.body;if(!m)throw new Error(`@EuropeanBrandAuthStrategy.login: after login redirection got stuck : ${y}`);if(m.includes("login-actions/required-action")){const t=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(y),i=/name="code" value="(.*)"/gi.exec(y);if(!t)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions url.");if(!i)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions code.");const n=t[1].startsWith("/")?`${l.protocol}//${l.host}${t[1]}`:t[1],r=new a;r.append("code",i[1]),r.append("accept","");const{headers:{location:s},body:d}=yield ge(e.post(n,{cookieJar:o,body:r.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},pe)}));if(!s){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(d);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication action failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication action failed, cannot retrieve error message")}const c=yield e(s,{cookieJar:o,headers:pe});m=c.url,y=c.body}const{body:b,statusCode:C}=yield e.post(this.environment.endpoints.silentSignIn,{cookieJar:o,body:{intUserId:""},json:!0,headers:Object.assign(Object.assign({},pe),{"ccsp-service-id":this.environment.clientId})});if(!b.redirectUrl)throw new Error(`@EuropeanBrandAuthStrategy.login: silent sign In didn't work, could not retrieve auth code. status: ${C}, body: ${JSON.stringify(b)}`);const{code:w}=s.parse(b.redirectUrl,!0).query;if(!w)throw new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument code in ${b.redirectUrl}.`);return{code:w,cookies:o}}))}}class me{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanLegacyAuthStrategy"}login(t,i){return v(this,void 0,void 0,(function*(){const o=yield ve(this.environment,this.language,null==i?void 0:i.cookieJar),{body:n,statusCode:r}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!n.redirectUrl)throw new Error(`@EuropeanLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${r}, body: ${JSON.stringify(n)}`);const{code:a}=s.parse(n.redirectUrl,!0).query;if(!a)throw new Error("@EuropeanLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:a,cookies:o}}))}}class ye extends W{constructor(e){var t;if(super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:K(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.userConfig.language=null!==(t=e.language)&&void 0!==t?t:"en",!V.includes(this.userConfig.language))throw new Error(`The language code ${this.userConfig.language} is not managed. Only ${V.join(", ")} are.`);this.session.deviceId=K(),this._environment=H(e),this.authStrategies={main:new fe(this._environment,this.userConfig.language),fallback:new me(this._environment,this.userConfig.language)},k.debug("EU Controller created")}get environment(){return this._environment}refreshAccessToken(){return v(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return k.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return k.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return k.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw q(e,"EuropeController.refreshAccessToken")}return k.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return v(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw q(e,"EuropeController.pin")}}))}login(){return v(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@EuropeController.login: username and password must be defined.");let t=null;try{k.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){k.error(`@EuropeController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),k.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.fallback.name}`),t=yield this.authStrategies.fallback.login({password:this.userConfig.password,username:this.userConfig.username})}k.debug("@EuropeController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"APNS",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),k.debug("@EuropeController.login: Device registered");const n=new a;n.append("grant_type","authorization_code"),n.append("redirect_uri",this.environment.endpoints.redirectUri),n.append("code",t.code);const r=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:n.toString(),cookieJar:t.cookies});if(200!==r.statusCode)throw new Error(`@EuropeController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return k.debug("@EuropeController.login: Session defined properly"),"Login success"}catch(e){throw q(e,"EuropeController.login")}}))}logout(){return v(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return v(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield Z(t.body.resMsg.vehicles,(t=>v(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return k.debug(`@EuropeController.getVehicles: Added vehicle ${o.id}`),new ce(o,this)}))))}catch(e){throw q(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){return v(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return v(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return v(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}class be extends Y{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=F.CA,this.timeOffset=-(new Date).getTimezoneOffset()/60,this._info=null,k.debug(`CA Vehicle ${this.vehicleConfig.id} created`)}fullStatus(){throw new Error("Method not implemented.")}status(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m;const y=Object.assign(Object.assign({},B),e);k.debug("Begin status request, polling car",y.refresh);try{let e=null;if(y.useInfo)yield this.setInfo(y.refresh),this._info&&(e=this._info.status);else{const o=y.refresh?this.controller.environment.endpoints.remoteStatus:this.controller.environment.endpoints.status,n=yield this.request(o,{});if(e=null===(t=n.result)||void 0===t?void 0:t.status,null==n?void 0:n.error)throw null===(i=null==n?void 0:n.error)||void 0===i?void 0:i.errorDesc}k.debug(e);let b=null;return e&&(b={chassis:{hoodOpen:null==e?void 0:e.hoodOpen,trunkOpen:null==e?void 0:e.trunkOpen,locked:null==e?void 0:e.doorLock,openDoors:{frontRight:!!(null===(o=null==e?void 0:e.doorOpen)||void 0===o?void 0:o.frontRight),frontLeft:!!(null===(n=null==e?void 0:e.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==e?void 0:e.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(s=null==e?void 0:e.doorOpen)||void 0===s?void 0:s.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(a=null==e?void 0:e.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampRearLeft),frontLeft:!!(null===(d=null==e?void 0:e.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampFrontLeft),frontRight:!!(null===(l=null==e?void 0:e.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==e?void 0:e.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(h=null==e?void 0:e.tirePressureLamp)||void 0===h?void 0:h.tirePressureWarningLampAll)}},climate:{active:null==e?void 0:e.airCtrlOn,steeringwheelHeat:!!(null==e?void 0:e.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==e?void 0:e.sideBackWindowHeat),defrost:null==e?void 0:e.defrost,temperatureSetpoint:null===(u=null==e?void 0:e.airTemp)||void 0===u?void 0:u.value,temperatureUnit:null===(v=null==e?void 0:e.airTemp)||void 0===v?void 0:v.unit},engine:{ignition:null==e?void 0:e.engine,accessory:null==e?void 0:e.acc,range:null===(p=null==e?void 0:e.dte)||void 0===p?void 0:p.value,charging:null===(g=null==e?void 0:e.evStatus)||void 0===g?void 0:g.batteryCharge,batteryCharge12v:null===(f=null==e?void 0:e.battery)||void 0===f?void 0:f.batSoc,batteryChargeHV:null===(m=null==e?void 0:e.evStatus)||void 0===m?void 0:m.batteryStatus},lastupdate:se(null==e?void 0:e.lastStatusDate)}),this._status=y.parsed?b:e,this._status}catch(e){throw e.message}}))}lock(){return v(this,void 0,void 0,(function*(){k.debug("Begin lock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.lock,{},{pAuth:e}),"Lock successful"}catch(e){throw e.message}}))}unlock(){return v(this,void 0,void 0,(function*(){k.debug("Begin unlock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.unlock,{},{pAuth:e}),"Unlock successful"}catch(e){throw e.message}}))}start(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r;k.debug("Begin startClimate request");try{const s={hvacInfo:{airCtrl:null!==(t=e.hvac)&&void 0!==t&&t||null!==(i=e.defrost)&&void 0!==i&&i?1:0,defrost:null!==(o=e.defrost)&&void 0!==o&&o,heating1:e.heatedFeatures?1:0}},a=e.temperature;if(null!=a)s.hvacInfo.airTemp={value:ne(F.CA,a),unit:0,hvacTempType:1};else if(null!==(n=e.hvac)&&void 0!==n&&n||null!==(r=e.defrost)&&void 0!==r&&r)throw"air temperature should be specified";const d=yield this.getPreAuth(),l=yield this.request(this.controller.environment.endpoints.start,s,{pAuth:d});return k.debug(l),l.responseHeader&&0===l.responseHeader.responseCode?"Vehicle started!":"Failed to start vehicle"}catch(e){throw e.message}}))}stop(){return v(this,void 0,void 0,(function*(){k.debug("Begin stop request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.stop,{pAuth:e})}catch(e){throw"error: "+e}}))}lights(){return v(this,arguments,void 0,(function*(e=!1){k.debug("Begin lights request with horn "+e);try{const t=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.hornlight,{horn:e},{pAuth:t})}catch(e){throw"error: "+e}}))}stopCharge(){return v(this,void 0,void 0,(function*(){k.debug("Begin stopCharge");const{stopCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}startCharge(){return v(this,void 0,void 0,(function*(){k.debug("Begin startCharge");const{startCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}setChargeTargets(e){return v(this,void 0,void 0,(function*(){if(k.debug("Begin setChargeTarget"),!z.includes(e.fast)||!z.includes(e.slow))throw new G(`Charge target values are limited to ${z.join(", ")}`);const{setChargeTarget:t}=this.controller.environment.endpoints;try{const i=yield this.getPreAuth();return yield this.request(t,{pin:this.controller.userConfig.pin,pAuth:i,tsoc:[{plugType:ee.FAST,level:e.fast},{plugType:ee.SLOW,level:e.slow}]})}catch(e){throw"error: "+e}}))}odometer(){return v(this,void 0,void 0,(function*(){try{if(yield this.setInfo(),this._info)return{unit:this._info.vehicle.odometer,value:this._info.vehicle.odometerUnit};throw"error: no info"}catch(e){throw"error: "+e}}))}location(){return v(this,void 0,void 0,(function*(){k.debug("Begin locate request");try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.locate,{},{pAuth:e});return this._location=t.result,this._location}catch(e){throw"error: "+e}}))}getPreAuth(){return v(this,void 0,void 0,(function*(){k.info("Begin pre-authentication");try{return(yield this.request(this.controller.environment.endpoints.verifyPin,{})).result.pAuth}catch(e){throw"error: "+e}}))}request(t,i){return v(this,arguments,void 0,(function*(t,i,o={}){k.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`),yield this.controller.refreshAccessToken();const[n,,]=process.versions.node.split(".").map(Number);if(n>=21){i=Object.assign({pin:this.userConfig.pin},i),process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",k.debug("Node version >= 21, using fetch instead of got");const e={method:"POST",body:JSON.stringify(i),headers:Object.assign({from:this.controller.environment.origin,language:0,offset:this.timeOffset,accessToken:this.controller.session.accessToken,Origin:"https://kiaconnect.ca",Referer:"https://kiaconnect.ca/login","Content-Type":"application/json",vehicleId:this.vehicleConfig.id},o),dispatcher:new c({connect:{rejectUnauthorized:!1,secureOptions:l.constants.SSL_OP_LEGACY_SERVER_CONNECT}})};try{const i=yield h(t,e);return yield i.json()}catch(e){return void k.error(e)}}const r={method:"POST",json:!0,throwHttpErrors:!1,headers:Object.assign({from:this.controller.environment.origin,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},o),body:Object.assign({pin:this.userConfig.pin},i)};try{const i=yield e(t,r);return 0!=i.body.responseHeader.responseCode?i.body.responseHeader.responseDesc:i.body}catch(e){throw"error: "+e}}))}setInfo(){return v(this,arguments,void 0,(function*(e=!1){if(null===this._info||e)try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.vehicleInfo,{},{pAuth:e});this._info=t.result}catch(e){throw"error: "+e}}))}}class Ce extends W{constructor(e){super(e),this.vehicles=[],this.timeOffset=-(new Date).getTimezoneOffset()/60,k.debug("CA Controller created"),this._environment=A(e.brand)}get environment(){return this._environment}refreshAccessToken(){return v(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;return k.debug("shouldRefreshToken: "+e.toString()),this.session.refreshToken&&e?(yield this.login(),k.debug("Token refreshed"),"Token refreshed"):(k.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh")}))}login(){return v(this,void 0,void 0,(function*(){k.info("Begin login request");try{const e=yield this.request(this.environment.endpoints.login,{loginId:this.userConfig.username,password:this.userConfig.password});return k.debug(e.result),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),"login good"}catch(e){return"error: "+e}}))}logout(){return v(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return v(this,void 0,void 0,(function*(){k.info("Begin getVehicleList request");try{const e=(yield this.request(this.environment.endpoints.vehicleList,{})).result;return void 0===e.vehicles?(this.vehicles=[],this.vehicles):(e.vehicles.forEach((e=>{const t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};this.vehicles.push(new be(t,this))})),this.vehicles)}catch(e){return k.debug(e),this.vehicles}}))}request(t,i){return v(this,arguments,void 0,(function*(t,i,o={}){k.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`);const[n,,]=process.versions.node.split(".").map(Number);if(n>=21){process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",k.debug("Node version >= 21, using fetch instead of got");const e={method:"POST",body:JSON.stringify(i),headers:Object.assign({from:this.environment.origin,language:0,offset:this.timeOffset,accessToken:this.session.accessToken,Origin:"https://kiaconnect.ca",Referer:"https://kiaconnect.ca/login","Content-Type":"application/json"},o),dispatcher:new c({connect:{rejectUnauthorized:!1,secureOptions:l.constants.SSL_OP_LEGACY_SERVER_CONNECT}})};try{const i=yield h(t,e);return yield i.json()}catch(e){return void k.error(e)}}try{const n=yield e(t,{method:"POST",json:!0,headers:Object.assign({from:this.environment.origin,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},o),body:Object.assign({},i)});if(0!=n.body.responseHeader.responseCode)throw n.body.responseHeader.responseDesc;return n.body}catch(e){throw q(e,"CanadianController")}}))}}var we,ke;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(we||(we={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(ke||(ke={}));class Te extends Y{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=F.CN,this.serverRates={max:-1,current:-1},k.debug(`CN Vehicle ${this.vehicleConfig.id} created`)}start(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:1,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ne(F.CN,e.temperature),unit:e.unit}}));return k.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw q(e,"ChinaVehicle.start")}}))}stop(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return k.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw q(e,"ChinaVehicle.stop")}}))}lock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw q(e,"ChinaVehicle.lock")}}))}unlock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw q(e,"ChinaVehicle.unlock")}}))}fullStatus(e){return v(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},B),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.status;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg.status;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.coord}return this._fullStatus=e,this._fullStatus}catch(e){throw q(e,"ChinaVehicle.fullStatus")}}))}status(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,O,$,D,I,E,L,M,P,R,V,x,H,U,_,j,N,z,Y,J;const W=Object.assign(Object.assign({},B),e),G=yield this.controller.getVehicleHttpService();try{const e=W.refresh?"":"/latest",B=this.updateRates(yield G.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg.status,q={chassis:{hoodOpen:null==B?void 0:B.hoodOpen,trunkOpen:null==B?void 0:B.trunkOpen,locked:B.doorLock,openDoors:{frontRight:!!(null===(t=null==B?void 0:B.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==B?void 0:B.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==B?void 0:B.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==B?void 0:B.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==B?void 0:B.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==B?void 0:B.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==B?void 0:B.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==B?void 0:B.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==B?void 0:B.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==B?void 0:B.airCtrlOn,steeringwheelHeat:!!(null==B?void 0:B.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==B?void 0:B.sideBackWindowHeat),defrost:null==B?void 0:B.defrost,temperatureSetpoint:re(F.EU,null===(c=null==B?void 0:B.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==B?void 0:B.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:B.engine,accessory:null==B?void 0:B.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==B?void 0:B.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==B?void 0:B.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==B?void 0:B.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(S=null===(T=null===(k=null==B?void 0:B.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===S?void 0:S.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==B?void 0:B.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:X.UNPLUGED,charging:null===(D=null==B?void 0:B.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==B?void 0:B.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(R=null===(P=null===(M=null==B?void 0:B.evStatus)||void 0===M?void 0:M.remainTime2)||void 0===P?void 0:P.etc1)||void 0===R?void 0:R.value,estimatedPortableChargeDuration:null===(H=null===(x=null===(V=null==B?void 0:B.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===H?void 0:H.value,estimatedStationChargeDuration:null===(j=null===(_=null===(U=null==B?void 0:B.evStatus)||void 0===U?void 0:U.remainTime2)||void 0===_?void 0:_.etc3)||void 0===j?void 0:j.value,batteryCharge12v:null===(N=null==B?void 0:B.battery)||void 0===N?void 0:N.batSoc,batteryChargeHV:null===(z=null==B?void 0:B.evStatus)||void 0===z?void 0:z.batteryStatus},lastupdate:(null==B?void 0:B.time)?se(null==B?void 0:B.time):null};return q.engine.range||(q.engine.rangeEV||q.engine.rangeGas)&&(q.engine.range=(null!==(Y=q.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(J=q.engine.rangeGas)&&void 0!==J?J:0)),this._status=W.parsed?q:B,this._status}catch(e){throw q(e,"ChinaVehicle.status")}}))}odometer(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.status.odometer,this._odometer}catch(e){throw q(e,"ChinaVehicle.odometer")}}))}location(){return v(this,void 0,void 0,(function*(){var e,t,i,o,n,r,s;const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw q(e,"ChinaVehicle.location")}}))}startCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw q(e,"ChinaVehicle.startCharge")}}))}stopCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw q(e,"ChinaVehicle.stopCharge")}}))}monthlyReport(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:Se(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw q(e,"ChinaVehicle.monthyReports")}}))}tripInfo(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:Se(e),setTripDay:i?Ae(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?se(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=se(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ae(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw q(e,"ChinaVehicle.history")}}))}driveHistory(){return v(this,arguments,void 0,(function*(e=we.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?se(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw q(e,"ChinaVehicle.history")}}))}getChargeTargets(){return v(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw q(e,"ChinaVehicle.getChargeTargets")}}))}setChargeTargets(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!z.includes(e.fast)||!z.includes(e.slow))throw new G(`Charge target values are limited to ${z.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:ee.FAST,targetSOClevel:e.fast},{plugType:ee.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw q(e,"ChinaVehicle.setChargeTargets")}}))}setNavigation(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw q(e,"ChinaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function Se(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function Ae(e){return e.day?`${Se(e)}${e.day.toString().padStart(2,"0")}`:Se(e)}class Oe{constructor(e){this.environment=e}get name(){return"ChineseLegacyAuthStrategy"}login(t,i){return v(this,void 0,void 0,(function*(){const o=yield function(t,i){return v(this,void 0,void 0,(function*(){const o=null!=i?i:new d;return yield e(t.endpoints.session,{cookieJar:o}),yield e(t.endpoints.language,{method:"POST",body:'{"lang":"zh"}',cookieJar:o}),o}))}(this.environment,null==i?void 0:i.cookieJar),{body:n,statusCode:r}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!n.redirectUrl)throw new Error(`@ChineseLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${r}, body: ${JSON.stringify(n)}`);const{code:a}=s.parse(n.redirectUrl,!0).query;if(!a)throw new Error("@ChineseLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:a,cookies:o}}))}}class $e extends W{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:K(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=K(),this._environment=_(e),this.authStrategies={main:new Oe(this._environment)},k.debug("CN Controller created")}get environment(){return this._environment}refreshAccessToken(){return v(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return k.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return k.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return k.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw q(e,"ChinaController.refreshAccessToken")}return k.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return v(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin?token=`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,k.debug(`controlToken is : ${this.session.controlToken}`),this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw q(e,"ChinaController.pin")}}))}login(){return v(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@ChinaController.login: username and password must be defined.");let t=null;try{k.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){k.error(`@ChinaController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),k.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}k.debug("@ChinaController.login: Authenticated properly with user and password");const i=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId},body:{pushRegId:this.environment.pushRegId,providerDeviceId:this.environment.providerDeviceId,pushType:"GCM",uuid:K()},json:!0});i&&(this.session.deviceId=i.body.resMsg.deviceId),k.debug("@ChinaController.login: Device registered");const o=new a;o.append("grant_type","authorization_code"),o.append("redirect_uri",this.environment.endpoints.redirectUri),o.append("code",t.code);const n=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:o.toString(),cookieJar:t.cookies});if(200!==n.statusCode)throw new Error(`@ChinaController.login: Could not manage to get token: ${n.body}`);if(n){const e=JSON.parse(n.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return k.debug("@ChinaController.login: Session defined properly"),k.debug(`accessToken is ${this.session.accessToken}\n refreshToken is ${this.session.refreshToken}\n tokenExpiresAt : ${this.session.tokenExpiresAt}`),"Login success"}catch(e){throw q(e,"ChinaController.login")}}))}logout(){return v(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return v(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0});this.vehicles=yield Z(t.body.resMsg.vehicles,(t=>v(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return k.debug(`@ChineseController.getVehicles: Added vehicle ${o.id}`),new Te(o,this)}))))}catch(e){throw q(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){return v(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return v(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,AuthorizationCCSP:this.session.controlToken,"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c"}),json:!0})}))}getApiHttpService(){return v(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign({},this.defaultHeaders),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(0),"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c","ccsp-application-id":this.environment.appId,"Content-Type":"application/json","User-Agent":"okhttp/4.4.0"}}}class De extends Y{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=F.AU,this.serverRates={max:-1,current:-1},k.debug(`AU Vehicle ${this.vehicleConfig.id} created`)}start(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:ne(F.AU,e.temperature),unit:e.unit}}));return k.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw q(e,"AustraliaVehicle.start")}}))}stop(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return k.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw q(e,"AustraliaVehicle.stop")}}))}lock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw q(e,"AustraliaVehicle.lock")}}))}unlock(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(k.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw q(e,"AustraliaVehicle.unlock")}}))}setWindows(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/windowcurtain`,{body:e}));return k.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw q(e,"AustraliaVehicle.start")}}))}fullStatus(e){return v(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},B),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(t.refresh?yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`):yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`)),o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)),n=yield this.odometer();return n?(this._fullStatus={vehicleLocation:o.body.resMsg.gpsDetail,odometer:n,vehicleStatus:e.body.resMsg},this._fullStatus):null}catch(e){throw q(e,"AustraliaVehicle.fullStatus")}}))}status(e){return v(this,void 0,void 0,(function*(){var t,i,o,n,r,s,a,d,l,c,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,O,$,D,I,E,L,M,P,R,V,x,H,U,_,j,N,z,Y,J;const W=Object.assign(Object.assign({},B),e),G=yield this.controller.getVehicleHttpService();try{const e=W.refresh?"":"/latest",B=this.updateRates(yield G.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg,q={chassis:{hoodOpen:null==B?void 0:B.hoodOpen,trunkOpen:null==B?void 0:B.trunkOpen,locked:B.doorLock,openDoors:{frontRight:!!(null===(t=null==B?void 0:B.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==B?void 0:B.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==B?void 0:B.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==B?void 0:B.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==B?void 0:B.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==B?void 0:B.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==B?void 0:B.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==B?void 0:B.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==B?void 0:B.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==B?void 0:B.airCtrlOn,steeringwheelHeat:!!(null==B?void 0:B.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==B?void 0:B.sideBackWindowHeat),defrost:null==B?void 0:B.defrost,temperatureSetpoint:re(F.AU,null===(c=null==B?void 0:B.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(h=null==B?void 0:B.airTemp)||void 0===h?void 0:h.unit},engine:{ignition:B.engine,accessory:null==B?void 0:B.acc,rangeGas:null!==(f=null===(g=null===(p=null===(v=null===(u=null==B?void 0:B.evStatus)||void 0===u?void 0:u.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===g?void 0:g.value)&&void 0!==f?f:null===(m=null==B?void 0:B.dte)||void 0===m?void 0:m.value,range:null===(w=null===(C=null===(b=null===(y=null==B?void 0:B.evStatus)||void 0===y?void 0:y.drvDistance[0])||void 0===b?void 0:b.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===w?void 0:w.value,rangeEV:null===(A=null===(S=null===(T=null===(k=null==B?void 0:B.evStatus)||void 0===k?void 0:k.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===S?void 0:S.evModeRange)||void 0===A?void 0:A.value,plugedTo:null!==($=null===(O=null==B?void 0:B.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==$?$:X.UNPLUGED,charging:null===(D=null==B?void 0:B.evStatus)||void 0===D?void 0:D.batteryCharge,estimatedCurrentChargeDuration:null===(L=null===(E=null===(I=null==B?void 0:B.evStatus)||void 0===I?void 0:I.remainTime2)||void 0===E?void 0:E.atc)||void 0===L?void 0:L.value,estimatedFastChargeDuration:null===(R=null===(P=null===(M=null==B?void 0:B.evStatus)||void 0===M?void 0:M.remainTime2)||void 0===P?void 0:P.etc1)||void 0===R?void 0:R.value,estimatedPortableChargeDuration:null===(H=null===(x=null===(V=null==B?void 0:B.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===x?void 0:x.etc2)||void 0===H?void 0:H.value,estimatedStationChargeDuration:null===(j=null===(_=null===(U=null==B?void 0:B.evStatus)||void 0===U?void 0:U.remainTime2)||void 0===_?void 0:_.etc3)||void 0===j?void 0:j.value,batteryCharge12v:null===(N=null==B?void 0:B.battery)||void 0===N?void 0:N.batSoc,batteryChargeHV:null===(z=null==B?void 0:B.evStatus)||void 0===z?void 0:z.batteryStatus},lastupdate:(null==B?void 0:B.time)?se(null==B?void 0:B.time):null};return q.engine.range||(q.engine.rangeEV||q.engine.rangeGas)&&(q.engine.range=(null!==(Y=q.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(J=q.engine.rangeGas)&&void 0!==J?J:0)),this._status=W.parsed?q:B,this._status}catch(e){throw q(e,"AustraliaVehicle.status")}}))}odometer(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:Ie({year:(new Date).getFullYear(),month:(new Date).getMonth()+1})}}));return this._odometer={unit:0,value:t.body.resMsg.odometer},this._odometer}catch(e){throw q(e,"AustraliaVehicle.odometer")}}))}location(){return v(this,void 0,void 0,(function*(){var e,t,i,o,n,r;const s=yield this.controller.getVehicleHttpService();try{const a=null===(e=this.updateRates(yield s.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)).body.resMsg)||void 0===e?void 0:e.gpsDetail;return this._location={latitude:null===(t=null==a?void 0:a.coord)||void 0===t?void 0:t.lat,longitude:null===(i=null==a?void 0:a.coord)||void 0===i?void 0:i.lon,altitude:null===(o=null==a?void 0:a.coord)||void 0===o?void 0:o.alt,speed:{unit:null===(n=null==a?void 0:a.speed)||void 0===n?void 0:n.unit,value:null===(r=null==a?void 0:a.speed)||void 0===r?void 0:r.value},heading:null==a?void 0:a.head},this._location}catch(e){throw q(e,"AustraliaVehicle.location")}}))}startCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw q(e,"AustraliaVehicle.startCharge")}}))}stopCharge(){return v(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return k.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw q(e,"AustraliaVehicle.stopCharge")}}))}monthlyReport(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,c,h;const u=yield this.controller.getVehicleHttpService();try{const v=null===(t=this.updateRates(yield u.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:Ie(e)}})).body.resMsg)||void 0===t?void 0:t.monthlyReport;return v?{start:null===(i=v.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=v.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:v.breakdown,driving:v.driving?{distance:null===(n=v.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=v.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=v.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=v.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:v.vehicleStatus?{tpms:(null===(d=v.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=v.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(h=null===(c=v.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===h?void 0:h.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw q(e,"AustraliaVehicle.monthyReports")}}))}tripInfo(){return v(this,arguments,void 0,(function*(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:Ie(e),setTripDay:i?Ee(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?se(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=se(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ae(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw q(e,"AustraliaVehicle.history")}}))}driveHistory(){return v(this,arguments,void 0,(function*(e=de.DAY){var t,i;const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?se(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw q(e,"AustraliaVehicle.history")}}))}getChargeTargets(){return v(this,void 0,void 0,(function*(){var e;const t=yield this.controller.getVehicleHttpService();try{const i=null===(e=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)).body.resMsg)||void 0===e?void 0:e.targetSOClist;return i&&Array.isArray(i)?i.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw q(e,"AustraliaVehicle.getChargeTargets")}}))}setChargeTargets(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!z.includes(e.fast)||!z.includes(e.slow))throw new G(`Charge target values are limited to ${z.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:ee.FAST,targetSOClevel:e.fast},{plugType:ee.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw q(e,"AustraliaVehicle.setChargeTargets")}}))}setNavigation(e){return v(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw q(e,"AustraliaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function Ie(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function Ee(e){return e.day?`${Ie(e)}${e.day.toString().padStart(2,"0")}`:Ie(e)}class Le{constructor(e){this.environment=e}get name(){return"AustraliaAuthStrategy"}login(t,i){return v(this,void 0,void 0,(function*(){var o;const n=null!==(o=null==i?void 0:i.cookieJar)&&void 0!==o?o:new d;yield e(this.environment.endpoints.session,{cookieJar:n});const{body:r,statusCode:a}=yield e(this.environment.endpoints.login,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({email:t.username,password:t.password,mobileNum:""}),cookieJar:n}),l=JSON.parse(r);if(!l.redirectUrl)throw new Error(`@AustraliaAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${a}, body: ${JSON.stringify(l)}`);const{code:c}=s.parse(l.redirectUrl,!0).query;if(!c)throw new Error("@AustraliaAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:c,cookies:n}}))}}class Me extends W{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:K(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=K(),this._environment=N(e),this.authStrategy=new Le(this._environment),k.debug("AU Controller created")}get environment(){return this._environment}refreshAccessToken(){return v(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return k.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return k.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return k.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw q(e,"AustraliaController.refreshAccessToken")}return k.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return v(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw q(e,"AustraliaController.pin")}}))}login(){return v(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@AustraliaController.login: username and password must be defined.");let t=null;try{k.debug(`@AustraliaController.login: Trying to sign in with ${this.authStrategy.name}`),t=yield this.authStrategy.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){throw new Error(`@AustraliaController.login: sign in with ${this.authStrategy.name} failed with error ${e.toString()}`)}k.debug("@AustraliaController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"GCM",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),k.debug("@AustraliaController.login: Device registered");const n=new a;n.append("grant_type","authorization_code"),n.append("redirect_uri",this.environment.endpoints.redirectUri),n.append("code",t.code);const r=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:n.toString(),cookieJar:t.cookies});if(200!==r.statusCode)throw new Error(`@AustraliaController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return k.debug("@AustraliaController.login: Session defined properly"),"Login success"}catch(e){throw q(e,"AustraliaController.login")}}))}logout(){return v(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return v(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield Z(t.body.resMsg.vehicles,(t=>v(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return k.debug(`@AustraliaController.getVehicles: Added vehicle ${o.id}`),new De(o,this)}))))}catch(e){throw q(e,"AustraliaController.getVehicles")}return this.vehicles}))}checkControlToken(){return v(this,void 0,void 0,(function*(){var e;yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return v(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return v(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}const Pe={username:"",password:"",region:F.US,brand:"hyundai",autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0};class Re extends u{constructor(e){switch(super(),this.vehicles=[],this.config=Object.assign(Object.assign({},Pe),e),e.region){case F.EU:this.controller=new ye(this.config);break;case F.US:this.controller=new Q(this.config);break;case F.CA:this.controller=new Ce(this.config);break;case F.CN:this.controller=new $e(this.config);break;case F.AU:this.controller=new Me(this.config);break;default:throw new Error("Your region is not supported yet.")}void 0===e.autoLogin&&(this.config.autoLogin=!0),this.onInit()}on(e,t){return super.on(e,t)}onInit(){this.config.autoLogin&&(k.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())}login(){return v(this,void 0,void 0,(function*(){try{const e=yield this.controller.login();return this.vehicles=yield this.getVehicles(),k.debug(`Found ${this.vehicles.length} on the account`),this.emit("ready",this.vehicles),e}catch(e){return this.emit("error",e),e.message}}))}getVehicles(){return v(this,void 0,void 0,(function*(){return(yield this.controller.getVehicles())||[]}))}getVehicle(e){try{const t=this.vehicles.find((t=>t.vin().toLowerCase()===e.toLowerCase()));if(!t&&this.vehicles.length>0)throw new Error(`Could not find vehicle with id: ${e}`);return t}catch(t){throw new Error(`Vehicle not found: ${e}!`)}}refreshAccessToken(){return v(this,void 0,void 0,(function*(){return this.controller.refreshAccessToken()}))}logout(){return v(this,void 0,void 0,(function*(){return this.controller.logout()}))}getSession(){return this.controller.session}get cachedVehicles(){var e;return null!==(e=this.vehicles)&&void 0!==e?e:[]}}export{Re as BlueLinky,Re as default};
